# Async/Await æ·±å…¥ç†è§£

- last updateï¼š2020-12-14

<a href="https://github.com/daolou/book" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

é¦–å…ˆæƒ³è¦æ›´å¥½çš„ç†è§£ Async/Awaitï¼Œéœ€è¦äº†è§£è¿™ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š

- åŒæ­¥
- å¼‚æ­¥

## èƒŒæ™¯

é¦–å…ˆï¼Œ**js æ˜¯å•çº¿ç¨‹çš„ï¼ˆé‡å¤ä¸‰éï¼‰**ï¼Œæ‰€è°“å•çº¿ç¨‹ï¼Œ
é€šä¿—çš„è®²å°±æ˜¯ï¼Œ~~ä¸€æ ¹ç­‹~~ï¼ˆæ¯”å–»æœ‰ç‚¹è¿‡åˆ†ï¼Œå“ˆå“ˆï¼‰æ‰§è¡Œä»£ç æ˜¯ä¸€è¡Œä¸€è¡Œçš„å¾€ä¸‹èµ°ï¼ˆå³æ‰€è°“çš„**åŒæ­¥**ï¼‰ï¼Œ
å¦‚æœä¸Šé¢çš„æ²¡æ‰§è¡Œå®Œï¼Œå°±ç—´ç—´çš„ç­‰ç€ï¼ˆæ˜¯ä¸æ˜¯å¾ˆåƒæ‹çˆ±ä¸­åœ¨è·¯è¾¹ç­‰å¥¹/ä»–çš„ä½ ï¼Œå‡è£… new äº†ä¸ªå¯¹è±¡ï¼Œå•Šå“ˆå“ˆå“ˆï¼Œè°ƒçš®ä¸€ä¸‹å¾ˆå¼€å¿ƒï¼‰ï¼Œ
è¿˜æ˜¯ä¸¾ä¸ª ğŸŒ° å§ï¼š

```javascript
// chrome 81
function test() {
  let d = Date.now();
  for (let i = 0; i < 1e8; i++) {}
  console.log(Date.now() - d); // 62ms-90mså·¦å³
}

function test1() {
  let d = Date.now();

  console.log(Date.now() - d); // 0
}

test();
test1();
```

ä¸Šé¢ä»…ä»…æ˜¯ä¸€ä¸ª for å¾ªç¯ï¼Œè€Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¼šæœ‰å¤§é‡çš„ç½‘ç»œè¯·æ±‚ï¼Œå®ƒçš„å“åº”æ—¶é—´æ˜¯ä¸ç¡®å®šçš„ï¼Œè¿™ç§æƒ…å†µä¸‹ä¹Ÿè¦ç—´ç—´çš„ç­‰ä¹ˆï¼Ÿæ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œå› è€Œ js è®¾è®¡äº†å¼‚æ­¥ï¼Œå³ å‘èµ·ç½‘ç»œè¯·æ±‚ï¼ˆè¯¸å¦‚ IO æ“ä½œï¼Œå®šæ—¶å™¨ï¼‰ï¼Œç”±äºéœ€è¦ç­‰æœåŠ¡å™¨å“åº”ï¼Œå°±å…ˆä¸ç†ä¼šï¼Œè€Œæ˜¯å»åšå…¶ä»–çš„äº‹å„¿ï¼Œç­‰è¯·æ±‚è¿”å›äº†ç»“æœçš„æ—¶å€™å†è¯´ï¼ˆå³**å¼‚æ­¥**ï¼‰ã€‚
é‚£ä¹ˆå¦‚ä½•å®ç°å¼‚æ­¥å‘¢ï¼Ÿå…¶å®æˆ‘ä»¬å¹³æ—¶å·²ç»åœ¨å¤§é‡ä½¿ç”¨äº†ï¼Œé‚£å°±æ˜¯ `callback`ï¼Œä¾‹å¦‚ï¼š

```javascript
// ç½‘ç»œè¯·æ±‚
$.ajax({
  url: 'http://xxx',
  success: function(res) {
    console.log(res);
  },
});
```

success ä½œä¸ºå‡½æ•°ä¼ é€’è¿‡å»å¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯ç­‰è¯·æ±‚æˆåŠŸäº†æ‰æ‰§è¡Œï¼Œå³**å›è°ƒå‡½æ•°**ï¼ˆcallbackï¼‰

```javascript
// IOæ“ä½œ
const fs = require('fs');

fs.rename('æ—§æ–‡ä»¶.txt', 'æ–°æ–‡ä»¶.txt', err => {
  if (err) throw err;
  console.log('é‡å‘½åå®Œæˆ');
});
```

å’Œç½‘ç»œè¯·æ±‚ç±»ä¼¼ï¼Œç­‰åˆ° IO æ“ä½œæœ‰äº†ç»“æœï¼ˆæ— è®ºæˆåŠŸä¸å¦ï¼‰æ‰ä¼šæ‰§è¡Œç¬¬ä¸‰ä¸ªå‚æ•°ï¼š`(err)=>{}`

ä»ä¸Šé¢æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºï¼Œå®ç°å¼‚æ­¥çš„æ ¸å¿ƒå°±æ˜¯å›è°ƒé’©å­ï¼Œå°† cb ä½œä¸ºå‚æ•°ä¼ é€’ç»™å¼‚æ­¥æ‰§è¡Œå‡½æ•°ï¼Œå½“æœ‰äº†ç»“æœååœ¨è§¦å‘ cbã€‚æƒ³äº†è§£æ›´å¤šï¼Œå»çœ‹çœ‹ `event-loop` æœºåˆ¶å§ã€‚

è‡³äº async/await æ˜¯å¦‚ä½•å‡ºç°çš„å‘¢ï¼Œåœ¨ es6 ä¹‹å‰ï¼Œå¤§å¤š js æ•°é¡¹ç›®ä¸­ä¼šæœ‰ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š

```javascript
ajax1(url, () => {
  // do something 1
  ajax2(url, () => {
    // do something 2
    ajax3(url, () => {
      // do something 3
      // ...
    });
  });
});
```

è¿™ç§å‡½æ•°åµŒå¥—ï¼Œå¤§é‡çš„å›è°ƒå‡½æ•°ï¼Œä½¿ä»£ç é˜…è¯»èµ·æ¥æ™¦æ¶©éš¾æ‡‚ï¼Œä¸ç›´è§‚ï¼Œå½¢è±¡çš„ç§°ä¹‹ä¸º**å›è°ƒåœ°ç‹±ï¼ˆcallback hellï¼‰**ï¼Œæ‰€ä»¥ä¸ºäº†åœ¨å†™æ³•ä¸Šèƒ½æ›´é€šä¿—ä¸€ç‚¹ï¼Œes6+é™†ç»­å‡ºç°äº† `Promise`ã€`Generator`ã€`Async/await`ï¼ŒåŠ›æ±‚åœ¨å†™æ³•ä¸Šç®€æ´æ˜äº†ï¼ˆæ‰å¹³åŒ–ï¼‰ï¼Œå¯è¯»æ€§å¼ºï¼ˆæ›´ä¼˜é›…ã€æ›´ç®€æ´ï¼‰ã€‚

========================= æˆ‘æ˜¯åˆ†å‰²çº¿ ==========================

ä»¥ä¸Šåªæ˜¯é“ºå«ï¼Œä¸‹é¢åœ¨è¿›å…¥æ­£é¢˜ ğŸ‘‡ï¼Œå¼€å§‹è¯´é“è¯´é“ä¸»è§’ï¼š`async/await`

========================= æˆ‘æ˜¯åˆ†å‰²çº¿ ==========================

`async/await` æ˜¯å‚ç…§ `Generator` å°è£…çš„ä¸€å¥—å¼‚æ­¥å¤„ç†æ–¹æ¡ˆï¼Œå¯ä»¥ç†è§£ä¸º `Generator` çš„è¯­æ³•ç³–ï¼Œ

![async-await](./images/async-await.png)

æ‰€ä»¥äº†è§£ `async/await` å°±ä¸å¾—ä¸è®²ä¸€è®² `Generator`(é¦–æ¬¡å°†åç¨‹çš„æ¦‚å¿µå¼•å…¥ `js`ï¼Œæ˜¯åç¨‹çš„å­é›†ï¼Œä¸è¿‡ç”±äºä¸èƒ½æŒ‡å®šè®©æ­¥çš„åç¨‹ï¼Œåªèƒ½è®©æ­¥ç»™ç”Ÿæˆå™¨(è¿­ä»£å™¨)çš„è°ƒç”¨è€…ï¼Œæ‰€ä»¥ä¹Ÿç§°ä¸ºéå¯¹ç§°åç¨‹),

è€Œ `Generator` åˆè¿”å›è¿­ä»£å™¨`Iterator`å¯¹è±¡ï¼Œ

æ‰€ä»¥å°±å¾—å…ˆè®²ä¸€è®² `Iterator`,

è€Œ `Iterator` å’Œ `Generator` éƒ½å±äºåç¨‹ï¼Œ

ç»ˆäºæ‰¾åˆ°æºå¤´äº†ï¼šåç¨‹

## åç¨‹

> wikiï¼š[åç¨‹](https://zh.m.wikipedia.org/zh-cn/%E5%8D%8F%E7%A8%8B)ï¼ˆè‹±è¯­ï¼šcoroutineï¼‰æ˜¯è®¡ç®—æœºç¨‹åºçš„ä¸€ç±»ç»„ä»¶ï¼Œæ¨å¹¿äº†åä½œå¼å¤šä»»åŠ¡çš„å­ç¨‹åºï¼Œå…è®¸æ‰§è¡Œè¢«æŒ‚èµ·ä¸è¢«æ¢å¤ã€‚ç›¸å¯¹å­ä¾‹ç¨‹è€Œè¨€ï¼Œåç¨‹æ›´ä¸ºä¸€èˆ¬å’Œçµæ´»ï¼Œä½†åœ¨å®è·µä¸­ä½¿ç”¨æ²¡æœ‰å­ä¾‹ç¨‹é‚£æ ·å¹¿æ³›ã€‚åç¨‹æ›´é€‚åˆäºç”¨æ¥å®ç°å½¼æ­¤ç†Ÿæ‚‰çš„ç¨‹åºç»„ä»¶ï¼Œå¦‚åä½œå¼å¤šä»»åŠ¡ã€å¼‚å¸¸å¤„ç†ã€äº‹ä»¶å¾ªç¯ã€è¿­ä»£å™¨ã€æ— é™åˆ—è¡¨å’Œç®¡é“
>
> åç¨‹å¯ä»¥é€šè¿‡ yieldï¼ˆå–å…¶â€œè®©æ­¥â€ä¹‹ä¹‰è€Œéâ€œå‡ºäº§â€ï¼‰æ¥è°ƒç”¨å…¶å®ƒåç¨‹ï¼Œæ¥ä¸‹æ¥çš„æ¯æ¬¡åç¨‹è¢«è°ƒç”¨æ—¶,ä»åç¨‹ä¸Šæ¬¡ yield è¿”å›çš„ä½ç½®æ¥ç€æ‰§è¡Œï¼Œé€šè¿‡ yield æ–¹å¼è½¬ç§»æ‰§è¡Œæƒçš„åç¨‹ä¹‹é—´ä¸æ˜¯è°ƒç”¨è€…ä¸è¢«è°ƒç”¨è€…çš„å…³ç³»ï¼Œè€Œæ˜¯å½¼æ­¤å¯¹ç§°ã€å¹³ç­‰çš„
>
> åç¨‹æ˜¯è¿½æ±‚æé™æ€§èƒ½å’Œä¼˜ç¾çš„ä»£ç ç»“æ„çš„äº§ç‰©
> åç¨‹é—´çš„è°ƒç”¨æ˜¯é€»è¾‘ä¸Šå¯æ§çš„ï¼Œæ—¶åºä¸Šç¡®å®šçš„

åç¨‹æ˜¯ä¸€ç§æ¯”çº¿ç¨‹æ›´åŠ è½»é‡çº§çš„å­˜åœ¨ï¼Œæ˜¯è¯­è¨€å±‚çº§çš„æ„é€ ï¼Œå¯çœ‹ä½œä¸€ç§å½¢å¼çš„[æ§åˆ¶æµ](https://zh.m.wikipedia.org/wiki/æ§åˆ¶æµ)ï¼Œåœ¨å†…å­˜é—´æ‰§è¡Œï¼Œæ— åƒçº¿ç¨‹é—´åˆ‡æ¢çš„å¼€é”€ã€‚ä½ å¯ä»¥æŠŠåç¨‹çœ‹æˆæ˜¯è·‘åœ¨çº¿ç¨‹ä¸Šçš„ä»»åŠ¡ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸Šå¯ä»¥å­˜åœ¨å¤šä¸ªåç¨‹ï¼Œä½†æ˜¯åœ¨çº¿ç¨‹ä¸ŠåŒæ—¶åªèƒ½æ‰§è¡Œä¸€ä¸ªåç¨‹ã€‚

åç¨‹æ¦‚å¿µçš„æå‡ºæ¯”è¾ƒæ—©ï¼Œå•æ ¸CPUåœºæ™¯ä¸­å‘å±•å‡ºæ¥çš„æ¦‚å¿µï¼Œé€šè¿‡æä¾›**æŒ‚èµ·**å’Œ**æ¢å¤**æ¥å£ï¼Œå®ç°åœ¨å•ä¸ªCPUä¸Šäº¤å‰å¤„ç†å¤šä¸ªä»»åŠ¡çš„å¹¶å‘åŠŸèƒ½ã€‚

é‚£ä¹ˆæœ¬è´¨ä¸Šå°±æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†ä¸åŒä»»åŠ¡æ ˆçš„åˆ‡æ¢ï¼Œé€šè¿‡ä¸åŒä»»åŠ¡æ ˆçš„æŒ‚èµ·å’Œæ¢å¤ï¼Œçº¿ç¨‹ä¸­è¿›è¡Œäº¤æ›¿è¿è¡Œçš„ä»£ç ç‰‡æ®µï¼Œå®ç°å¹¶å‘çš„åŠŸèƒ½ã€‚

å…¶å®ä»è¿™é‡Œå¯ä»¥çœ‹å‡º ã€Œåç¨‹é—´çš„è°ƒç”¨æ˜¯é€»è¾‘ä¸Šå¯æ§çš„ï¼Œæ—¶åºä¸Šç¡®å®šçš„ã€

é‚£ä¹ˆå¦‚ä½•ç†è§£ js ä¸­çš„åç¨‹å‘¢ï¼Ÿ

- js å…¬è·¯åªæ˜¯å•è¡Œé“ï¼ˆä¸»çº¿ç¨‹ï¼‰ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šè½¦é“ï¼ˆè¾…åŠ©çº¿ç¨‹ï¼‰éƒ½å¯ä»¥æ±‡å…¥è½¦æµï¼ˆå¼‚æ­¥ä»»åŠ¡å®Œæˆåå›è°ƒè¿›å…¥ä¸»çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—ï¼‰
- `generator` æŠŠ js å…¬è·¯å˜æˆäº†å¤šè½¦é“ï¼ˆåç¨‹å®ç°ï¼‰ï¼Œä½†æ˜¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè½¦é“ä¸Šçš„è½¦èƒ½å¼€ï¼ˆä¾ç„¶å•çº¿ç¨‹ï¼‰ï¼Œä¸è¿‡å¯ä»¥è‡ªç”±å˜é“ï¼ˆç§»äº¤æ§åˆ¶æƒï¼‰

### åç¨‹å®ç°

è¿™é‡Œæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­è¯æ˜åç¨‹çš„å®ç”¨æ€§ã€‚å‡è®¾è¿™æ ·ä¸€ç§ç”Ÿäº§è€…ï¼æ¶ˆè´¹è€…çš„å…³ç³»ï¼Œä¸€ä¸ªåç¨‹ç”Ÿäº§äº§å“å¹¶å°†å®ƒä»¬åŠ å…¥é˜Ÿåˆ—ï¼Œå¦ä¸€ä¸ªåç¨‹ä»é˜Ÿåˆ—ä¸­å–å‡ºäº§å“å¹¶æ¶ˆè´¹å®ƒä»¬ã€‚ä¼ªç è¡¨ç¤ºå¦‚ä¸‹ï¼š

```txt
var q := æ–°å»ºé˜Ÿåˆ—

coroutine ç”Ÿäº§è€…
  loop
    while q ä¸æ»¡è½½
      å»ºç«‹æŸäº›æ–°äº§å“
      å‘ q å¢åŠ è¿™äº›äº§å“
    yield ç»™æ¶ˆè´¹è€…

coroutine æ¶ˆè´¹è€…
  loop
    while q ä¸ç©ºè½½
      ä» q ç§»é™¤æŸäº›äº§å“
      ä½¿ç”¨è¿™äº›äº§å“
    yield ç»™ç”Ÿäº§è€…
```

v8 å®ç°æºç ï¼š[js-generator](https://github.com/v8/v8/blob/master/src/objects/js-generator.h)ã€[runtime-generator](https://github.com/v8/v8/blob/master/src/runtime/runtime-generator.cc)

ç¼–è¯‘æ¨¡æ‹Ÿå®ç°(es5)ï¼š[regenerator](https://github.com/facebook/regenerator)

é€šè¿‡ä»¥ä¸Šï¼Œæˆ‘å‡è£…ä½ æ˜ç™½ä»€ä¹ˆæ˜¯åç¨‹ï¼Œä¸‹ä¸€æ­¥å¼€å§‹è¯´ä¸€è¯´**è¿­ä»£å™¨** `Iterator`

## Iterator

`Iterator` ç¿»è¯‘è¿‡æ¥å°±æ˜¯**è¿­ä»£å™¨ï¼ˆéå†å™¨ï¼‰**è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒçš„éå†è¿‡ç¨‹(ç±»ä¼¼äºå•å‘é“¾è¡¨)ï¼š

- åˆ›å»ºä¸€ä¸ª**æŒ‡é’ˆå¯¹è±¡**ï¼ŒæŒ‡å‘å½“å‰æ•°æ®ç»“æ„çš„èµ·å§‹ä½ç½®
- ç¬¬ä¸€æ¬¡è°ƒç”¨æŒ‡é’ˆå¯¹è±¡çš„ `next` æ–¹æ³•ï¼Œå°†æŒ‡é’ˆæŒ‡å‘æ•°æ®ç»“æ„çš„ç¬¬ä¸€ä¸ªæˆå‘˜
- ç¬¬äºŒæ¬¡è°ƒç”¨æŒ‡é’ˆå¯¹è±¡çš„ `next` æ–¹æ³•ï¼Œå°†æŒ‡é’ˆæŒ‡å‘æ•°æ®ç»“æ„çš„ç¬¬äºŒä¸ªæˆå‘˜
- ä¸æ–­çš„è°ƒç”¨æŒ‡é’ˆå¯¹è±¡çš„ `next` æ–¹æ³•ï¼Œç›´åˆ°å®ƒæŒ‡å‘æ•°æ®ç»“æ„çš„ç»“æŸä½ç½®

ä¸€ä¸ªå¯¹è±¡è¦å˜æˆå¯è¿­ä»£çš„ï¼Œå¿…é¡»å®ç° `@@iterator` æ–¹æ³•ï¼Œå³å¯¹è±¡ï¼ˆæˆ–å®ƒåŸå‹é“¾ä¸Šçš„æŸä¸ªå¯¹è±¡ï¼‰å¿…é¡»æœ‰ä¸€ä¸ªåå­—æ˜¯ `Symbol.iterator` çš„å±æ€§ï¼ˆåŸç”Ÿå…·æœ‰è¯¥å±æ€§çš„æœ‰ï¼š`String`ã€`Array`ã€`TypedArray`ã€`Map` å’Œ `Set`ï¼‰å¯é€šè¿‡å¸¸é‡ `Symbol.iterator` è®¿é—®ï¼š

| å±æ€§               | å€¼                                               |
| :----------------- | :----------------------------------------------- |
| [Symbol.iterator]: | è¿”å›ä¸€ä¸ªå¯¹è±¡çš„æ— å‚å‡½æ•°ï¼Œè¢«è¿”å›å¯¹è±¡ç¬¦åˆè¿­ä»£å™¨åè®® |

å½“ä¸€ä¸ªå¯¹è±¡éœ€è¦è¢«è¿­ä»£çš„æ—¶å€™ï¼ˆæ¯”å¦‚å¼€å§‹ç”¨äºä¸€ä¸ª `for..of` å¾ªç¯ä¸­ï¼‰ï¼Œå®ƒçš„ `@@iterator` æ–¹æ³•è¢«è°ƒç”¨å¹¶ä¸”æ— å‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªç”¨äºåœ¨è¿­ä»£ä¸­è·å¾—å€¼çš„è¿­ä»£å™¨

è¿­ä»£å™¨åè®®ï¼šäº§ç”Ÿä¸€ä¸ªæœ‰é™æˆ–æ— é™åºåˆ—çš„å€¼ï¼Œå¹¶ä¸”å½“æ‰€æœ‰çš„å€¼éƒ½å·²ç»è¢«è¿­ä»£åï¼Œå°±ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„è¿”å›å€¼

å½“ä¸€ä¸ªå¯¹è±¡åªæœ‰æ»¡è¶³ä¸‹è¿°æ¡ä»¶æ‰ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªè¿­ä»£å™¨ï¼š

å®ƒå®ç°äº†ä¸€ä¸ª `next()` çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•**å¿…é¡»è¿”å›ä¸€ä¸ªå¯¹è±¡**,å¯¹è±¡æœ‰ä¸¤ä¸ªå¿…è¦çš„å±æ€§ï¼š

- `done`ï¼ˆboolï¼‰
  - trueï¼šè¿­ä»£å™¨å·²ç»è¶…è¿‡äº†å¯è¿­ä»£æ¬¡æ•°ã€‚è¿™ç§æƒ…å†µä¸‹,value çš„å€¼å¯ä»¥è¢«çœç•¥
  - å¦‚æœè¿­ä»£å™¨å¯ä»¥äº§ç”Ÿåºåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªå€¼ï¼Œåˆ™ä¸º falseã€‚è¿™ç­‰æ•ˆäºæ²¡æœ‰æŒ‡å®š done è¿™ä¸ªå±æ€§
- `value` è¿­ä»£å™¨è¿”å›çš„ä»»ä½• JavaScript å€¼ã€‚done ä¸º true æ—¶å¯çœç•¥

æ ¹æ®ä¸Šé¢çš„è§„åˆ™ï¼Œå’±ä»¬æ¥è‡ªå®šä¹‰ä¸€ä¸ªç®€å•çš„è¿­ä»£å™¨ï¼š

```javascript
const getRawType = (target) => Object.prototype.toString.call(target).slice(8,-1);

const __createArrayIterable = (arr) => {
  if (typeof Symbol !== 'function' || !Symbol.iterator) return {};
  if(getRawType(arr) !== 'Array') throw new Error('it must be Array');
  const iterable = {};
  iterable[Symbol.iterator] = () => {
    arr.length++;
    const iterator = {
      next: () => ({ value: arr.shift(), done: arr.length <= 0 })
    }
    return iterator;
  };
  return iterable;
};

const itable = __createArrayIterable(['äººæœˆ',  'ç¥è¯']);
const it = itable[Symbol.iterator]();

console.log(it.next()); // { value: "äººæœˆ", done: false }
console.log(it.next()); // { value: "ç¥è¯", done: false }
console.log(it.next()); // {value: undefined, done: true }
```

æˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼š

```javascript
Object.prototype[Symbol.iterator] = function () {
  const items = Object.entries(this);
  items.length++;
  return {
    next: () => ({ value: items.shift(), done: items.length <= 0 })
  }
}
// or
Object.prototype[Symbol.iterator] = function* () {
  const items = Object.entries(this);
  for (const item of items) {
    yield item;
  }
}
const obj = { name: 'amap', bu: 'sharetrip'}
for (let value of obj) {
  console.log(value);
}
// ["name", "amap"]
// ["bu", "sharetrip"]
// or
console.log([...obj]); // [["name", "amap"], ["bu", "sharetrip"]]
```

### ğŸ’¡ é™¤äº† for map forEach ç­‰æ–¹æ³•å¦‚ä½•éå†ä¸€ä¸ªæ•°ç»„ï¼Ÿ

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<pre><code>
const getIterator = (iteratorable) => iteratorable[Symbol.iterator]();
const arr = [0,1,2,3,4,5];
const iterator = getIterator(arr);
while(true){
  const obj = iterator.next();
  if(obj.done){
    break;
  }
  console.log(obj.value);
}
</code></pre>
</details>

äº†è§£äº†è¿­ä»£å™¨ï¼Œä¸‹é¢å¯ä»¥è¿›ä¸€æ­¥äº†è§£ç”Ÿæˆå™¨äº†

## Generator

`Generator`ï¼šç”Ÿæˆå™¨å¯¹è±¡æ˜¯ç”Ÿæˆå™¨å‡½æ•°ï¼ˆGeneratorFunctionï¼‰è¿”å›çš„ï¼Œå®ƒç¬¦åˆ**å¯è¿­ä»£åè®®**å’Œ**è¿­ä»£å™¨åè®®**ï¼Œæ—¢æ˜¯è¿­ä»£å™¨ä¹Ÿæ˜¯å¯è¿­ä»£å¯¹è±¡ï¼Œå¯ä»¥è°ƒç”¨ `next` æ–¹æ³•ï¼Œä½†å®ƒä¸æ˜¯å‡½æ•°ï¼Œæ›´ä¸æ˜¯æ„é€ å‡½æ•°

ç”Ÿæˆå™¨å‡½æ•°ï¼ˆGeneratorFunctionï¼‰ï¼š

> function\* name([param[, param[, ... param]]]) { statements }
>
> - nameï¼šå‡½æ•°å
> - paramï¼šå‚æ•°
> - statementsï¼šjs è¯­å¥

è°ƒç”¨ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°å¹¶ä¸ä¼šé©¬ä¸Šæ‰§è¡Œå®ƒé‡Œé¢çš„è¯­å¥ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªè¿™ä¸ªç”Ÿæˆå™¨çš„è¿­ä»£å™¨å¯¹è±¡ï¼Œå½“è¿™ä¸ªè¿­ä»£å™¨çš„ `next()` æ–¹æ³•è¢«é¦–æ¬¡ï¼ˆåç»­ï¼‰è°ƒç”¨æ—¶ï¼Œå…¶å†…çš„è¯­å¥ä¼šæ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ªï¼ˆåç»­ï¼‰å‡ºç° `yield` çš„ä½ç½®ä¸ºæ­¢ï¼ˆè®©æ‰§è¡Œå¤„äº**æš‚åœçŠ¶**ï¼ŒæŒ‚èµ·ï¼‰ï¼Œ`yield` åç´§è·Ÿè¿­ä»£å™¨è¦è¿”å›çš„å€¼ã€‚æˆ–è€…å¦‚æœç”¨çš„æ˜¯ `yield*`ï¼ˆå¤šäº†ä¸ªæ˜Ÿå·ï¼‰ï¼Œåˆ™è¡¨ç¤ºå°†æ‰§è¡Œæƒç§»äº¤ç»™å¦ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°ï¼ˆå½“å‰ç”Ÿæˆå™¨**æš‚åœæ‰§è¡Œ**ï¼‰ï¼Œè°ƒç”¨ `next()` ï¼ˆå†å¯åŠ¨ï¼Œå”¤é†’ï¼‰æ–¹æ³•æ—¶ï¼Œå¦‚æœä¼ å…¥äº†å‚æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªå‚æ•°ä¼šä½œä¸º**ä¸Šä¸€æ¡æ‰§è¡Œçš„ `yield` è¯­å¥çš„è¿”å›å€¼**ï¼Œä¾‹å¦‚ï¼š

```javascript
function* another() {
  yield 'äººæœˆç¥è¯';
}

function* gen() {
  yield* another(); // ç§»äº¤æ‰§è¡Œæƒ
  const a = yield 'hello';
  const b = yield a; // a='world' æ˜¯ next('world') ä¼ å‚èµ‹å€¼ç»™äº†ä¸Šä¸€ä¸ª yidle 'hello' çš„å·¦å€¼
  yield b; // b=ï¼ æ˜¯ next('ï¼') ä¼ å‚èµ‹å€¼ç»™äº†ä¸Šä¸€ä¸ª yidle a çš„å·¦å€¼
}

const g = gen();
g.next(); // {value: "äººæœˆç¥è¯", done: false}
g.next(); // {value: "hello", done: false}
g.next('world'); // {value: "world", done: false} å°† 'world' èµ‹ç»™ä¸Šä¸€æ¡ yield 'hello' çš„å·¦å€¼ï¼Œå³æ‰§è¡Œ a='world'ï¼Œ
g.next('!'); // {value: "!", done: false} å°† '!' èµ‹ç»™ä¸Šä¸€æ¡ yield a çš„å·¦å€¼ï¼Œå³æ‰§è¡Œ b='!'ï¼Œè¿”å› b
g.next(); // {value: undefined, done: false}
```

çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šé—®ï¼Œ`Generator` å’Œ `callback` æœ‰å•¥å…³ç³»ï¼Œå¦‚ä½•å¤„ç†å¼‚æ­¥å‘¢ï¼Ÿå…¶å®äºŒè€…æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œæˆ‘ä»¬åªæ˜¯é€šè¿‡ä¸€äº›æ–¹å¼å¼ºè¡Œçš„å®ƒä»¬äº§ç”Ÿäº†å…³ç³»ï¼Œæ‰ä¼šæœ‰ `Generator` å¤„ç†å¼‚æ­¥

æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ `Generator` çš„æœ¬è´¨ï¼Œæš‚åœï¼Œå®ƒä¼šè®©ç¨‹åºæ‰§è¡Œåˆ°æŒ‡å®šä½ç½®å…ˆæš‚åœï¼ˆ`yield`ï¼‰ï¼Œç„¶åå†å¯åŠ¨ï¼ˆ`next`ï¼‰ï¼Œå†æš‚åœï¼ˆ`yield`ï¼‰ï¼Œå†å¯åŠ¨ï¼ˆ`next`ï¼‰ï¼Œè€Œè¿™ä¸ªæš‚åœå°±å¾ˆå®¹æ˜“è®©å®ƒå’Œå¼‚æ­¥æ“ä½œäº§ç”Ÿè”ç³»ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å¤„ç†å¼‚æ­¥æ—¶ï¼šå¼€å§‹å¼‚æ­¥å¤„ç†ï¼ˆç½‘ç»œæ±‚æƒ…ã€IO æ“ä½œï¼‰ï¼Œç„¶åæš‚åœä¸€ä¸‹ï¼Œç­‰å¤„ç†å®Œäº†ï¼Œå†è¯¥å¹²å˜›å¹²å˜›ã€‚ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ**js æ˜¯å•çº¿ç¨‹çš„ï¼ˆåˆé‡å¤äº†ä¸‰éï¼‰**ï¼Œå¼‚æ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œcallback è¿˜æ˜¯ callbackï¼Œä¸ä¼šå› ä¸º `Generator` è€Œæœ‰ä»»ä½•æ”¹å˜

ä¸‹é¢æ¥çœ‹çœ‹ï¼Œç”¨ `Generator` + `Promise` å†™ä¸€æ®µå¼‚æ­¥ä»£ç ï¼š

```javascript
const gen = function*() {
  const res1 = yield Promise.resolve({a: 1});
  const res2 = yield Promise.resolve({b: 2});
};

const g = gen();

const g1 = g.next();

console.log('g1:', g1);

g1.value
  .then(res1 => {
    console.log('res1:', res1);
    const g2 = g.next(res1);
    console.log('g2:', g2);
    g2.value
      .then(res2 => {
        console.log('res2:', res2);
        g.next(res2);
      })
      .catch(err2 => {
        console.log(err2);
      });
  })
  .catch(err1 => {
    console.log(err1);
  });
// g1: { value: Promise { <pending> }, done: false }
// res1: { "a": 1 }
// g2: { value: Promise { <pending> }, done: false }
// res2: { "b": 2 }
```

ä»¥ä¸Šä»£ç æ˜¯ `Generator` å’Œ `callback` ç»“åˆå®ç°çš„å¼‚æ­¥ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä»ç„¶éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ `.then` å±‚å±‚æ·»åŠ å›è°ƒï¼Œä½†ç”±äº `next()` æ–¹æ³•è¿”å›å¯¹è±¡ `{value: xxx,done: true/false}` æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç®€åŒ–å®ƒï¼Œå†™ä¸€ä¸ªè‡ªåŠ¨æ‰§è¡Œå™¨ï¼š

```javascript
function run(gen) {
  const g = gen();

  function next(data) {
    const res = g.next(data);
    // æ·±åº¦é€’å½’ï¼Œåªè¦ `Generator` å‡½æ•°è¿˜æ²¡æ‰§è¡Œåˆ°æœ€åä¸€æ­¥ï¼Œ`next` å‡½æ•°å°±è°ƒç”¨è‡ªèº«
    if (res.done) return res.value;
    res.value.then(function(data) {
      next(data);
    });
  }

  next();
}

run(function*() {
  const res1 = yield Promise.resolve({a: 1});
  console.log(res1);
  // { "a": 1 }
  const res2 = yield Promise.resolve({b: 2});
  console.log(res2);
  // { "b": 2 }
});
```

è¯´äº†è¿™ä¹ˆå¤šï¼Œæ€ä¹ˆè¿˜æ²¡æœ‰åˆ° `async/await`ï¼Œå®¢å®˜åˆ«æ€¥ï¼Œé©¬ä¸Šæ¥äº†ï¼ˆå…¶å®æˆ‘å·²ç»æ¼äº†ä¸€äº›å†…å®¹æ²¡è¯´ï¼šPromise å’Œ callback çš„å…³ç³»ï¼Œthunk å‡½æ•°ï¼Œco åº“ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å» google ä¸€ä¸‹ï¼Œruanyifeng è€å¸ˆè®²çš„[es6 å…¥é—¨](http://es6.ruanyifeng.com)éå¸¸æ£’ï¼Œæˆ‘æ—¶ä¸æ—¶çš„éƒ½ä¼šå»çœ‹ä¸€çœ‹ï¼‰

### ğŸ’¡ åˆ†æä¸‹é¢ log è¾“å‡ºä»€ä¹ˆå†…å®¹ï¼Ÿ

```js
function* gen() {
  const ask1 = yield "2 + 2 = ?";
  console.log(ask1);

  const ask2 = yield "3 * 3 = ?"
  console.log(ask2);
}

const generator = gen();

console.log( generator.next().value );

console.log( generator.next(4).value );

console.log( generator.next(9).done );
```

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<pre><code>
// 2 + 2 = ?
// 4
// 3 + 3 = ?
// 6
// true
</code></pre>
</details>

## Async/Await

é¦–å…ˆï¼Œ`async/await` æ˜¯ `Generator` çš„è¯­æ³•ç³–ï¼Œä¸Šé¢*æˆ‘æ˜¯åˆ†å‰²çº¿*ä¸‹çš„ç¬¬ä¸€å¥å·²ç»è®²è¿‡ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹äºŒè€…çš„å¯¹æ¯”ï¼š

```javascript
// Generator
run(function*() {
  const res1 = yield Promise.resolve({a: 1});
  console.log(res1);

  const res2 = yield Promise.resolve({b: 2});
  console.log(res2);
});

// async/await
const aa = async ()=>{
  const res1 = await Promise.resolve({a: 1});
  console.log(res1);

  const res2 = await Promise.resolve({b: 2});
  console.log(res2);

  return 'done'ï¼›
}
const res = aa();
```

å¯ä»¥çœ‹åˆ°ï¼Œ`async function` ä»£æ›¿äº† `function*`ï¼Œ`await` ä»£æ›¿äº† `yield`ï¼ŒåŒæ—¶ä¹Ÿæ— éœ€è‡ªå·±æ‰‹å†™ä¸€ä¸ªè‡ªåŠ¨æ‰§è¡Œå™¨ `run` äº†

ç°åœ¨å†æ¥çœ‹çœ‹`async/await` çš„ç‰¹ç‚¹ï¼š

- å½“ `await` åé¢è·Ÿçš„æ˜¯ Promise å¯¹è±¡æ—¶ï¼Œæ‰ä¼šå¼‚æ­¥æ‰§è¡Œï¼Œå…¶å®ƒç±»å‹çš„æ•°æ®ä¼šåŒæ­¥æ‰§è¡Œ
- æ‰§è¡Œ `const res = aa();` è¿”å›çš„ä»ç„¶æ˜¯ä¸ª Promise å¯¹è±¡ï¼Œä¸Šé¢ä»£ç ä¸­çš„ `return 'done';` ä¼šç›´æ¥è¢«ä¸‹é¢ `then` å‡½æ•°æ¥æ”¶åˆ°

```javascript
res.then(data => {
  console.log(data); // done
});
```

æœ€åå’±ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼š

ä¼˜ç‚¹ï¼š

- å†…ç½®æ‰§è¡Œå™¨ï¼šè‡ªå¸¦æ‰§è¡Œå™¨
- æ›´å¥½çš„è¯­ä¹‰ï¼šæ¯”èµ·æ˜Ÿå·å’Œ `yield`ï¼Œè¯­ä¹‰æ›´æ¸…æ¥šäº†
- æ›´å¹¿çš„é€‚ç”¨æ€§ï¼š`await` å‘½ä»¤åé¢ï¼Œå¯ä»¥è·Ÿ `Promise` å¯¹è±¡å’ŒåŸå§‹ç±»å‹çš„å€¼ï¼ˆè¿™æ—¶ç­‰åŒäºåŒæ­¥æ“ä½œï¼‰

æ³¨æ„ç‚¹ï¼š

- `await` å‘½ä»¤åé¢çš„ `Promise` å¯¹è±¡ï¼Œè¿è¡Œç»“æœå¯èƒ½æ˜¯ `rejected`ï¼Œæ‰€ä»¥æœ€å¥½æŠŠ `await` å‘½ä»¤æ”¾åœ¨ `try...catch` ä»£ç å—ä¸­
- `await` å‘½ä»¤åªèƒ½ç”¨åœ¨ `async` å‡½æ•°ä¹‹ä¸­ï¼Œå¦‚æœç”¨åœ¨æ™®é€šå‡½æ•°ï¼Œå°±ä¼šæŠ¥é”™
- å¤šä¸ª `await` å‘½ä»¤åé¢çš„å¼‚æ­¥æ“ä½œï¼Œå¦‚æœä¸å­˜åœ¨ç»§å‘å…³ç³»ï¼Œæœ€å¥½è®©å®ƒä»¬åŒæ—¶è§¦å‘ï¼ˆ`Promise.all`ï¼‰
- å†å¾ªç¯ä¸­éœ€æ³¨æ„å®ƒçš„ä½¿ç”¨ï¼Œå°½é‡åœ¨ `for/for..of`ï¼ˆè¿­ä»£éå†å™¨ï¼‰ ä¸­ä½¿ç”¨ï¼Œæ°¸è¿œä¸è¦åœ¨ `forEach/filter` ä¸­ä½¿ç”¨ï¼Œä¹Ÿå°½é‡ä¸è¦åœ¨ `map` ä¸­ä½¿ç”¨
- å…¼å®¹æ€§ï¼ˆ[caniuse](https://caniuse.com/)ã€[node.green](https://node.green/)ï¼‰ä¸å¤ªå¥½ï¼Œå½“ç„¶ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯ä»¥å€ŸåŠ©ç¼–è¯‘å·¥å…·æ¥è¿›è¡Œ  polyfillï¼ˆbabelï¼‰æˆ– es6-shimï¼ˆè½¬æ¢åå³è¯­æ³•ç³–å®ç°çš„åç¨‹æ•ˆç‡ä½ï¼Œ`co + generator` æ¯” `cb` çš„æ–¹å¼æ€§èƒ½å·®ï¼‰
- å¯ä»¥åœ¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­ä½¿ç”¨ï¼Œåœ¨çº¿ä¾‹å­:  [React](https://codesandbox.io/s/async-zai-componentdidmount-zhongdeshiyong-dcwq9?file=/src/components/AsyncCom.tsx)ã€[Vue](https://codesandbox.io/s/zai-mounted-zhongshiyong-asyncawait-hpbct?file=/src/components/AsyncCom.vue)
- é”™è¯¯æ•è·ï¼šéœ€è¦æ•è·å¤šä¸ªé”™è¯¯å¹¶åšä¸åŒçš„å¤„ç†æ—¶ï¼Œå¯ä»¥è€ƒè™‘ç»™ `await` åçš„ `promise` å¯¹è±¡æ·»åŠ  `catch` å‡½æ•°ï¼Œä¸ºæ­¤æˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ª `helper`:

```javascript
// to.js
export default function to(promise) {
  return promise.then(data => {
    return [null, data];
  })
  .catch(err => [err]);
}

/***ä½¿ç”¨***/
import to from './to';

async function asyncTask() {

  const [err1, res1] = await to(fn1);
  if(!res1) throw new CustomerError('No res1 found');

  const [err2, res2] = await to(fn2);
  if(err) throw new CustomError('Error occurred while task2');
}
```

### ğŸ’¡ ç»™å®šä¸€ä¸ª URL æ•°ç»„ï¼Œå¦‚ä½•å®ç°æ¥å£çš„ç»§å‘å’Œå¹¶å‘ï¼Ÿ

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<pre><code>
// ç»§å‘ä¸€
async function loadData() {
  var res1 = await fetch(url1);
  var res2 = await fetch(url2);
  var res3 = await fetch(url3);
  return "when all done";
}
// ç»§å‘äºŒ
async function loadData(urls) {
  for (const url of urls) {
    const response = await fetch(url);
    console.log(await response.text());
  }
}
/********/
// å¹¶å‘ä¸€
async function loadData() {
  var res = await Promise.all([fetch(url1), fetch(url2), fetch(url3)]);
  return "when all done";
}
// å¹¶å‘äºŒ
async function loadData(urls) {
  // å¹¶å‘è¯»å– url
  const textPromises = urls.map(async url => {
    const response = await fetch(url);
    return response.text();
  });
  // æŒ‰æ¬¡åºè¾“å‡º
  for (const textPromise of textPromises) {
    console.log(await textPromise);
  }
}
</code></pre>
</details>

å•Šï¼Œç»ˆäºå®Œäº†ï¼Œä¸€ä¸ª `async-await` è¿å¸¦å‡ºæ¥è¿™ä¹ˆå¤šçŸ¥è¯†ç‚¹ï¼Œä»¥ååœ¨ä½¿ç”¨å®ƒæ—¶ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©åˆ°ä½ 

ã€å‚è€ƒã€‘ï¼š

1. <https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Iteration_protocols#%E5%8F%AF%E8%BF%AD%E4%BB%A3%E5%8D%8F%E8%AE%AE>
2. <http://es6.ruanyifeng.com/#docs/iterator>
3. <http://es6.ruanyifeng.com/#docs/async>

===ğŸ§ğŸ§ _æ–‡ä¸­ä¸è¶³ï¼Œæ¬¢è¿æŒ‡æ­£_ ğŸ¤ªğŸ¤ª===
