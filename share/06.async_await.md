# Async/Await å¦‚ä½•é€šè¿‡åŒæ­¥çš„æ–¹å¼å®ç°å¼‚æ­¥

<a href="https://github.com/daolou/book" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

ä½œä¸ºå‰ç«¯äººå‘˜è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦äº†è§£è¿™ä¸‰ä¸ªçŸ¥è¯†ç‚¹ï¼š

- åŒæ­¥
- å¼‚æ­¥
- Async/Await

é¦–å…ˆï¼Œ**js æ˜¯å•çº¿ç¨‹çš„ï¼ˆé‡å¤ä¸‰éï¼‰**ï¼Œæ‰€è°“å•çº¿ç¨‹ï¼Œ
é€šä¿—çš„è®²å°±æ˜¯ï¼Œ~~ä¸€æ ¹ç­‹~~ï¼ˆæ¯”å–»æœ‰ç‚¹è¿‡åˆ†ï¼Œå“ˆå“ˆï¼‰æ‰§è¡Œä»£ç æ˜¯ä¸€è¡Œä¸€è¡Œçš„å¾€ä¸‹èµ°ï¼ˆå³æ‰€è°“çš„**åŒæ­¥**ï¼‰ï¼Œ
å¦‚æœä¸Šé¢çš„æ²¡æ‰§è¡Œå®Œï¼Œå°±ç—´ç—´çš„ç­‰ç€ï¼ˆæ˜¯ä¸æ˜¯å¾ˆåƒæ‹çˆ±ä¸­åœ¨è·¯è¾¹ç­‰å¥¹/ä»–çš„ä½ ï¼Œå‡è£… new äº†ä¸ªå¯¹è±¡ï¼Œå•Šå“ˆå“ˆå“ˆï¼Œè°ƒçš®ä¸€ä¸‹å¾ˆå¼€å¿ƒï¼‰ï¼Œ
è¿˜æ˜¯ä¸¾ä¸ª ğŸŒ° å§ï¼š

```javascript
// chrome 75
function test() {
  let d = Date.now();
  for (let i = 0; i < 1e8; i++) {}
  console.log(Date.now() - d); // 62mså·¦å³
}
function test1() {
  let d = Date.now();

  console.log(Date.now() - d); // 0
}
test();
test1();
```

ä¸Šé¢ä»…ä»…æ˜¯ä¸€ä¸ª for å¾ªç¯ï¼Œè€Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¼šæœ‰å¤§é‡çš„ç½‘ç»œè¯·æ±‚ï¼Œå®ƒçš„å“åº”æ—¶é—´æ˜¯ä¸ç¡®å®šçš„ï¼Œè¿™ç§æƒ…å†µä¸‹ä¹Ÿè¦ç—´ç—´çš„ç­‰ä¹ˆï¼Ÿæ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œå› è€Œ js è®¾è®¡äº†å¼‚æ­¥ï¼Œå³ å‘èµ·ç½‘ç»œè¯·æ±‚ï¼ˆè¯¸å¦‚ IO æ“ä½œï¼Œå®šæ—¶å™¨ï¼‰ï¼Œç”±äºéœ€è¦ç­‰æœåŠ¡å™¨å“åº”ï¼Œå°±å…ˆä¸ç†ä¼šï¼Œè€Œæ˜¯å»åšå…¶ä»–çš„äº‹å„¿ï¼Œç­‰è¯·æ±‚è¿”å›äº†ç»“æœçš„æ—¶å€™å†è¯´ï¼ˆå³**å¼‚æ­¥**ï¼‰ã€‚
é‚£ä¹ˆå¦‚ä½•å®ç°å¼‚æ­¥å‘¢ï¼Ÿå…¶å®æˆ‘ä»¬å¹³æ—¶å·²ç»åœ¨å¤§é‡ä½¿ç”¨äº†ï¼Œé‚£å°±æ˜¯ `callback`ï¼Œä¾‹å¦‚ï¼š

```javascript
$.ajax({
  url: 'http://xxx',
  success: function(res) {
    console.log(res);
  },
});
```

success ä½œä¸ºå‡½æ•°ä¼ é€’è¿‡å»å¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯ç­‰è¯·æ±‚æˆåŠŸäº†æ‰æ‰§è¡Œï¼Œå³**å›è°ƒå‡½æ•°**ï¼ˆcallbackï¼‰

```javascript
const fs = require('fs');
fs.rename('æ—§æ–‡ä»¶.txt', 'æ–°æ–‡ä»¶.txt', err => {
  if (err) throw err;
  console.log('é‡å‘½åå®Œæˆ');
});
```

å’Œç½‘ç»œè¯·æ±‚ç±»ä¼¼ï¼Œç­‰åˆ° IO æ“ä½œæœ‰äº†ç»“æœï¼ˆæ— è®ºæˆåŠŸä¸å¦ï¼‰æ‰ä¼šæ‰§è¡Œç¬¬ä¸‰ä¸ªå‚æ•°ï¼š`(err)=>{}`

ä»ä¸Šé¢æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºï¼Œå®ç°å¼‚æ­¥çš„æ ¸å¿ƒå°±æ˜¯å›è°ƒé’©å­ï¼Œå°† cb ä½œä¸ºå‚æ•°ä¼ é€’ç»™å¼‚æ­¥æ‰§è¡Œå‡½æ•°ï¼Œå½“æœ‰äº†ç»“æœååœ¨è§¦å‘ cbã€‚æƒ³äº†è§£æ›´å¤šï¼Œå»çœ‹çœ‹ `event-loop` æœºåˆ¶å§ã€‚

è‡³äº async/await æ˜¯å¦‚ä½•å‡ºç°çš„å‘¢ï¼Œåœ¨ es6 ä¹‹å‰ï¼Œå¤§å¤š js æ•°é¡¹ç›®ä¸­ä¼šæœ‰ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š

```javascript
ajax1(url, () => {
  ajax2(url, () => {
    ajax3(url, () => {
      // do something
    });
  });
});
```

è¿™ç§å‡½æ•°åµŒå¥—ï¼Œå¤§é‡çš„å›è°ƒå‡½æ•°ï¼Œä½¿ä»£ç é˜…è¯»èµ·æ¥æ™¦æ¶©éš¾æ‡‚ï¼Œä¸ç›´è§‚ï¼Œå½¢è±¡çš„ç§°ä¹‹ä¸º**å›è°ƒåœ°ç‹±ï¼ˆcallback hellï¼‰**ï¼Œæ‰€ä»¥ä¸ºäº†åœ¨å†™æ³•ä¸Šèƒ½æ›´é€šä¿—ä¸€ç‚¹ï¼Œes6+é™†ç»­å‡ºç°äº† `Promise`ã€`Generator`ã€`Async/await`ï¼ŒåŠ›æ±‚åœ¨å†™æ³•ä¸Šç®€æ´æ˜äº†ï¼Œå¯è¯»æ€§å¼ºã€‚

=========================æˆ‘æ˜¯åˆ†å‰²çº¿==========================

ä»¥ä¸Šåªæ˜¯é“ºå«ï¼Œä¸‹é¢åœ¨è¿›å…¥æ­£é¢˜ ğŸ‘‡ï¼Œå¼€å§‹è¯´é“è¯´é“ä¸»è§’ï¼š`async/await`

=========================æˆ‘æ˜¯åˆ†å‰²çº¿==========================

`async/await` æ˜¯å‚ç…§ `Generator` å°è£…çš„ä¸€å¥—å¼‚æ­¥å¤„ç†æ–¹æ¡ˆï¼Œå¯ä»¥ç†è§£ä¸º `Generator` çš„è¯­æ³•ç³–ï¼Œ

æ‰€ä»¥äº†è§£ `async/await` å°±ä¸å¾—ä¸è®²ä¸€è®² `Generator`,

è€Œ `Generator` åˆä¾èµ–äºè¿­ä»£å™¨`Iterator`ï¼Œ

æ‰€ä»¥å°±å¾—å…ˆè®²ä¸€è®² `Iterator`,

è€Œ `Iterator` çš„æ€æƒ³å‘¢åˆæ¥æºäºå•å‘é“¾è¡¨ï¼Œ

ç»ˆäºæ‰¾åˆ°æºå¤´äº†ï¼šå•å‘é“¾è¡¨

## 1. å•å‘é“¾è¡¨

> wikiï¼šé“¾è¡¨ï¼ˆLinked listï¼‰æ˜¯ä¸€ç§å¸¸è§çš„åŸºç¡€æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸€ç§[çº¿æ€§è¡¨](https://zh.wikipedia.org/wiki/%E7%BA%BF%E6%80%A7%E8%A1%A8)ï¼Œä½†æ˜¯å¹¶ä¸ä¼šæŒ‰çº¿æ€§çš„é¡ºåºå‚¨å­˜æ•°æ®ï¼Œè€Œæ˜¯åœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹é‡Œå­˜åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„[æŒ‡é’ˆ](<https://zh.wikipedia.org/wiki/%E6%8C%87%E6%A8%99_(%E9%9B%BB%E8%85%A6%E7%A7%91%E5%AD%B8)>)ï¼ˆPointerï¼‰ã€‚ç”±äºä¸å¿…é¡»æŒ‰é¡ºåºå‚¨å­˜ï¼Œé“¾è¡¨åœ¨æ’å…¥çš„æ—¶å€™å¯ä»¥è¾¾åˆ° o(1)çš„å¤æ‚åº¦ï¼Œæ¯”å¦ä¸€ç§çº¿æ€§è¡¨[é¡ºåºè¡¨](https://zh.wikipedia.org/wiki/%E9%A1%BA%E5%BA%8F%E8%A1%A8)å¿«å¾—å¤šï¼Œä½†æ˜¯æŸ¥æ‰¾ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…è®¿é—®ç‰¹å®šç¼–å·çš„èŠ‚ç‚¹åˆ™éœ€è¦ o(n)çš„æ—¶é—´ï¼Œè€Œé¡ºåºè¡¨å“åº”çš„æ—¶é—´å¤æ‚åº¦åˆ†åˆ«æ˜¯ o(logn)å’Œ o(1)ã€‚

æ€»ç»“ä¸€ä¸‹é“¾è¡¨ä¼˜ç‚¹ï¼š

- æ— éœ€é¢„å…ˆåˆ†é…å†…å­˜
- æ’å…¥/åˆ é™¤èŠ‚ç‚¹ä¸å½±å“å…¶ä»–èŠ‚ç‚¹ï¼Œæ•ˆç‡é«˜ï¼ˆå…¸å‹çš„ä¾‹å­ï¼šdom æ“ä½œï¼‰

å•å‘é“¾è¡¨ï¼šæ˜¯é“¾è¡¨ä¸­æœ€ç®€å•çš„ä¸€ç§ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªåŸŸï¼Œä¸€ä¸ªä¿¡æ¯åŸŸå’Œä¸€ä¸ªæŒ‡é’ˆåŸŸã€‚è¿™ä¸ªé“¾æ¥æŒ‡å‘åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œæœ€åä¸€ä¸ªèŠ‚ç‚¹åˆ™æŒ‡å‘ä¸€ä¸ªç©ºå€¼ã€‚
![image](https://user-images.githubusercontent.com/22312092/61137396-00932a00-a4f8-11e9-8ba9-7f89104d9959.png)
ä¸€ä¸ªå•å‘é“¾è¡¨åŒ…å«ä¸¤ä¸ªå€¼: å½“å‰èŠ‚ç‚¹çš„å€¼å’Œä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„é“¾æ¥

å•é“¾ç‰¹ç‚¹ï¼šèŠ‚ç‚¹çš„é“¾æ¥æ–¹å‘æ˜¯å•å‘çš„ï¼›ç›¸å¯¹äºæ•°ç»„æ¥è¯´ï¼Œå•é“¾è¡¨çš„çš„éšæœºè®¿é—®é€Ÿåº¦è¾ƒæ…¢ï¼Œä½†æ˜¯å•é“¾è¡¨åˆ é™¤/æ·»åŠ æ•°æ®çš„æ•ˆç‡å¾ˆé«˜ã€‚

ç†è§£ js åŸå‹é“¾/ä½œç”¨åŸŸé“¾çš„è¯ï¼Œç†è§£è¿™ä¸ªå¾ˆå®¹æ˜“ï¼Œä»–ä»¬æ˜¯ç›¸é€šçš„ã€‚~~ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæ•°ç»„çš„é•¿åº¦æ—¶å›ºå®šçš„ï¼Œæ‰€ä»¥æ•°ç»„ä¸­çš„å¢åŠ å’Œåˆ é™¤æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦é¢‘ç¹çš„ç§»åŠ¨æ•°ç»„ä¸­çš„å…¶ä»–å…ƒç´ ï¼Œè€Œ js ä½œä¸ºä¸€é—¨åŠ¨æ€è¯­è¨€ï¼Œæ•°ç»„æœ¬è´¨æ˜¯ä¸€ä¸ªç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼Œæ˜¯åŠ¨æ€çš„ï¼Œä¸éœ€è¦é¢„å…ˆåˆ†é…å†…å­˜~~

é‚£ä¹ˆå¦‚ä½•è®¾è®¡ä¸€ä¸ªå•å‘é“¾è¡¨å‘¢ï¼Ÿè¿™ä¸ªå–å†³äºæˆ‘ä»¬éœ€è¦å“ªäº›æ“ä½œï¼Œé€šå¸¸æœ‰ï¼š

- append(element)ï¼šè¿½åŠ èŠ‚ç‚¹
- insert(element,index)ï¼šåœ¨ç´¢å¼•ä½ç½®æ’å…¥èŠ‚ç‚¹
- remove(element)ï¼šåˆ é™¤ç¬¬ä¸€ä¸ªåŒ¹é…åˆ°çš„èŠ‚ç‚¹
- removeAt(index)ï¼šåˆ é™¤æŒ‡å®šç´¢å¼•èŠ‚ç‚¹
- removeAll(element)ï¼šåˆ é™¤æ‰€æœ‰åŒ¹é…çš„èŠ‚ç‚¹
- get(index)ï¼šè·å–æŒ‡å®šç´¢å¼•çš„èŠ‚ç‚¹ä¿¡æ¯
- set(element,index)ï¼šä¿®æ”¹æŒ‡å®šç´¢å¼•çš„èŠ‚ç‚¹å€¼
- indexOf(element)ï¼šè·å–æŸèŠ‚ç‚¹çš„ç´¢å¼•ä½ç½®
- clear()ï¼šæ¸…é™¤æ‰€æœ‰èŠ‚ç‚¹
- length()ï¼šè¿”å›èŠ‚ç‚¹é•¿åº¦
- printf()ï¼šæ‰“å°èŠ‚ç‚¹ä¿¡æ¯

çœ‹åˆ°è¿™äº›æ–¹æ³•æ˜¯ä¸æ˜¯æœ‰äº›è®¸ç†Ÿæ‚‰ï¼Œå½“ä½ ç”¨åŸç”Ÿ js æˆ– jq æ—¶å¸¸ä¼šç”¨ä¸Šé¢ç±»ä¼¼çš„æ–¹æ³•ï¼Œç°åœ¨æ ¹æ®ä¸Šé¢åˆ—å‡ºçš„æ–¹æ³•è¿›è¡Œå®ç°ä¸€ä¸ªå•å‘é“¾ï¼š

```javascript
// èŠ‚ç‚¹æ¨¡å‹
class LinkNode {
  constructor(element, next) {
    this.element = element;
    this.next = next;
  }
}

class LinkedList {
  constructor() {
    this._head = null;
    this._size = 0;
    this._errorBoundary = this._errorBoundary.bind(this);
    this._getNodeByIndex = this._getNodeByIndex.bind(this);
    this.append = this.append.bind(this);
    this.insert = this.insert.bind(this);
    this.remove = this.remove.bind(this);
    this.removeAt = this.removeAt.bind(this);
    this.removeAll = this.removeAll.bind(this);
    this.getElement = this.getElement.bind(this);
    this.setIndex = this.setIndex.bind(this);
    this.indexOf = this.indexOf.bind(this);
    this.clear = this.clear.bind(this);
    this.length = this.length.bind(this);
    this.printf = this.printf.bind(this);
  }

  // è¾¹ç•Œæ£€éªŒ
  _errorBoundary(index) {
    if (index < 0 || index >= this._size) {
      throw `è¶…å‡ºè¾¹ç•Œ(${0}~${this._size})ï¼Œç›®æ ‡ä½ç½®${index}ä¸å­˜åœ¨ï¼`;
    }
  }
  // æ ¹æ®ç´¢å¼•è·å–ç›®æ ‡å¯¹è±¡
  _getNodeByIndex(index) {
    this._errorBoundary(index);
    let obj = this._head;
    for (let i = 0; i < index; i++) {
      obj = obj.next;
    }
    return obj;
  }
  // è¿½åŠ èŠ‚ç‚¹
  append(element) {
    if (this._size === 0) {
      this._head = new LinkNode(element, null);
    } else {
      let obj = this._getNodeByIndex(this._size - 1);
      obj.next = new LinkNode(element, null);
    }
    this._size++;
  }
  // åœ¨ç´¢å¼•ä½ç½®æ’å…¥èŠ‚ç‚¹
  insert(element, index) {
    if (index === 0) {
      this._head = new LinkNode(element, this._head);
    } else {
      let obj = this._getNodeByIndex(index - 1);
      obj.next = new LinkNode(element, obj.next);
    }
    this._size++;
  }
  // åˆ é™¤ç¬¬ä¸€ä¸ªåŒ¹é…åˆ°çš„èŠ‚ç‚¹
  remove(element) {
    if (this._size < 1) return null;

    if (this._head.element == element) {
      this._head.element = this._head.next;
      this._size--;
      return element;
    } else {
      let temp = this._head;
      while (temp.next) {
        if (temp.next.element == element) {
          temp.next = temp.next.next;
          this._size--;
          return element;
        } else {
          temp = temp.next;
        }
      }
    }
    return null;
  }
  // åˆ é™¤æŒ‡å®šç´¢å¼•èŠ‚ç‚¹
  removeAt(index) {
    this._errorBoundary(index);
    let element = null;
    if (index === 0) {
      element = this._head.element;
      this._head = this._head.next;
    } else {
      let prev = this._getNodeByIndex(index - 1);
      element = prev.next.element;
      prev.next = prev.next.next;
    }
    this._size--;
    return element;
  }
  // åˆ é™¤æ‰€æœ‰åŒ¹é…çš„èŠ‚ç‚¹
  removeAll(element) {
    // åˆ›å»ºè™šæ‹Ÿå¤´èŠ‚ç‚¹ï¼Œ
    let v_head = new LinkNode(null, this._head);
    let tempNode = v_head;
    // let tempEle = null;
    while (tempNode.next) {
      if (tempNode.next.element == element) {
        tempNode.next = tempNode.next.next;
        this._size--;
        // tempEle = element;
      } else {
        tempNode = tempNode.next;
      }
    }
    this._head = v_head.next;
  }
  // è·å–æŒ‡å®šç´¢å¼•çš„èŠ‚ç‚¹ä¿¡æ¯
  getElement(index) {
    return this._getNodeByIndex(index).element;
  }
  // ä¿®æ”¹æŒ‡å®šç´¢å¼•çš„èŠ‚ç‚¹å€¼
  setIndex(element, index) {
    this._errorBoundary(index);
    let obj = this._getNodeByIndex(index);
    obj.element = element;
  }
  // è·å–æŸèŠ‚ç‚¹çš„ç´¢å¼•ä½ç½®
  indexOf(element) {
    let obj = this._head;
    let index = -1;
    for (let i = 0; i < this._size; i++) {
      if (obj.element == element) {
        index = i;
        break;
      }
      obj = obj.next;
    }
    return index;
  }
  // æ¸…é™¤æ‰€æœ‰èŠ‚ç‚¹
  clear() {
    this._head = null;
    this._size = 0;
  }
  // è¿”å›èŠ‚ç‚¹é•¿åº¦
  length() {
    return this._size;
  }
  // æ‰“å°èŠ‚ç‚¹ä¿¡æ¯
  printf() {
    let obj = this._head;
    const arr = [];
    while (obj != null) {
      arr.push(obj.element);
      obj = obj.next;
    }
    const str = arr.join('->');
    return str || null;
  }
}

const obj = new LinkedList();
obj.append(0);
obj.append(1);
obj.append(2);
obj.printf();
// "0->1->2"

obj.insert(3, 3);
obj.printf();
// "0->1->2->3"

obj.remove(3);
obj.printf();
// "0->1->2"

obj.removeAt(0);
obj.printf();
// "1->2"

obj.setIndex(0, 0);
obj.printf();
// "0->2"

obj.indexOf(2);
// 1

obj.length();
// 2

obj.clear();
obj.printf();
// null
```

[æŸ¥çœ‹æºç ](https://github.com/daolou/book/blob/master/code/linked.js)

é€šè¿‡ä»¥ä¸Šï¼Œæˆ‘å‡è£…ä½ æ˜ç™½ä»€ä¹ˆæ˜¯å•å‘é“¾è¡¨ï¼Œå¹¶ä¸”èƒ½å¤Ÿç”¨ä»£ç å®ç°ä¸€ä¸ªå•å‘é“¾è¡¨äº†ï¼Œä¸‹ä¸€æ­¥å¼€å§‹è¯´ä¸€è¯´**è¿­ä»£å™¨** `Iterator`

## 2. Iterator

`Iterator` ç¿»è¯‘è¿‡æ¥å°±æ˜¯**è¿­ä»£å™¨ï¼ˆéå†å™¨ï¼‰**è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒçš„éå†è¿‡ç¨‹(ç±»ä¼¼äºå•å‘é“¾è¡¨)ï¼š

- åˆ›å»ºä¸€ä¸ª**æŒ‡é’ˆå¯¹è±¡**ï¼ŒæŒ‡å‘å½“å‰æ•°æ®ç»“æ„çš„èµ·å§‹ä½ç½®
- ç¬¬ä¸€æ¬¡è°ƒç”¨æŒ‡é’ˆå¯¹è±¡çš„ `next` æ–¹æ³•ï¼Œå°†æŒ‡é’ˆæŒ‡å‘æ•°æ®ç»“æ„çš„ç¬¬ä¸€ä¸ªæˆå‘˜
- ç¬¬äºŒæ¬¡è°ƒç”¨æŒ‡é’ˆå¯¹è±¡çš„ `next` æ–¹æ³•ï¼Œå°†æŒ‡é’ˆæŒ‡å‘æ•°æ®ç»“æ„çš„ç¬¬äºŒä¸ªæˆå‘˜
- ä¸æ–­çš„è°ƒç”¨æŒ‡é’ˆå¯¹è±¡çš„ `next` æ–¹æ³•ï¼Œç›´åˆ°å®ƒæŒ‡å‘æ•°æ®ç»“æ„çš„ç»“æŸä½ç½®

ä¸€ä¸ªå¯¹è±¡è¦å˜æˆå¯è¿­ä»£çš„ï¼Œå¿…é¡»å®ç° `@@iterator` æ–¹æ³•ï¼Œå³å¯¹è±¡ï¼ˆæˆ–å®ƒåŸå‹é“¾ä¸Šçš„æŸä¸ªå¯¹è±¡ï¼‰å¿…é¡»æœ‰ä¸€ä¸ªåå­—æ˜¯ `Symbol.iterator` çš„å±æ€§ï¼ˆåŸç”Ÿå…·æœ‰è¯¥å±æ€§çš„æœ‰ï¼šå­—ç¬¦ä¸²ã€æ•°ç»„ã€ç±»æ•°ç»„çš„å¯¹è±¡ã€Set å’Œ Mapï¼‰ï¼š

| å±æ€§               | å€¼                                               |
| :----------------- | :----------------------------------------------- |
| [Symbol.iterator]: | è¿”å›ä¸€ä¸ªå¯¹è±¡çš„æ— å‚å‡½æ•°ï¼Œè¢«è¿”å›å¯¹è±¡ç¬¦åˆè¿­ä»£å™¨åè®® |

å½“ä¸€ä¸ªå¯¹è±¡éœ€è¦è¢«è¿­ä»£çš„æ—¶å€™ï¼ˆæ¯”å¦‚å¼€å§‹ç”¨äºä¸€ä¸ª `for..of` å¾ªç¯ä¸­ï¼‰ï¼Œå®ƒçš„ `@@iterator` æ–¹æ³•è¢«è°ƒç”¨å¹¶ä¸”æ— å‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªç”¨äºåœ¨è¿­ä»£ä¸­è·å¾—å€¼çš„è¿­ä»£å™¨

è¿­ä»£å™¨åè®®ï¼šäº§ç”Ÿä¸€ä¸ªæœ‰é™æˆ–æ— é™åºåˆ—çš„å€¼ï¼Œå¹¶ä¸”å½“æ‰€æœ‰çš„å€¼éƒ½å·²ç»è¢«è¿­ä»£åï¼Œå°±ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„è¿”å›å€¼

å½“ä¸€ä¸ªå¯¹è±¡åªæœ‰æ»¡è¶³ä¸‹è¿°æ¡ä»¶æ‰ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªè¿­ä»£å™¨ï¼š

å®ƒå®ç°äº†ä¸€ä¸ª `next()` çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•**å¿…é¡»è¿”å›ä¸€ä¸ªå¯¹è±¡**,å¯¹è±¡æœ‰ä¸¤ä¸ªå¿…è¦çš„å±æ€§ï¼š

- `done`ï¼ˆboolï¼‰
  - trueï¼šè¿­ä»£å™¨å·²ç»è¶…è¿‡äº†å¯è¿­ä»£æ¬¡æ•°ã€‚è¿™ç§æƒ…å†µä¸‹,value çš„å€¼å¯ä»¥è¢«çœç•¥
  - å¦‚æœè¿­ä»£å™¨å¯ä»¥äº§ç”Ÿåºåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªå€¼ï¼Œåˆ™ä¸º falseã€‚è¿™ç­‰æ•ˆäºæ²¡æœ‰æŒ‡å®š done è¿™ä¸ªå±æ€§
- `value` è¿­ä»£å™¨è¿”å›çš„ä»»ä½• JavaScript å€¼ã€‚done ä¸º true æ—¶å¯çœç•¥

æ ¹æ®ä¸Šé¢çš„è§„åˆ™ï¼Œå’±ä»¬æ¥è‡ªå®šä¹‰ä¸€ä¸ªç®€å•çš„è¿­ä»£å™¨ï¼š

```javascript
const makeIterator = arr => {
  let nextIndex = 0;
  return {
    next: () =>
      nextIndex < arr.length
        ? { value: arr[nextIndex++], done: false }
        : { value: undefined, done: true },
  };
};
const it = makeIterator(['äººæœˆ', 'ç¥è¯']);
console.log(it.next()); // { value: "äººæœˆ", done: false }
console.log(it.next()); // { value: "ç¥è¯", done: false }
console.log(it.next()); // {value: undefined, done: true }
```

æˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼š

```javascript
const myIterable = {};
myIterable[Symbol.iterator] = function*() {
  yield 1;
  yield 2;
  yield 3;
};

for (let value of myIterable) {
  console.log(value);
}
// 1
// 2
// 3

//or

console.log([...myIterable]); // [1, 2, 3]
```

äº†è§£äº†è¿­ä»£å™¨ï¼Œä¸‹é¢å¯ä»¥è¿›ä¸€æ­¥äº†è§£ç”Ÿæˆå™¨äº†

## 3. Generator

`Generator`ï¼šç”Ÿæˆå™¨å¯¹è±¡æ˜¯ç”Ÿæˆå™¨å‡½æ•°ï¼ˆGeneratorFunctionï¼‰è¿”å›çš„ï¼Œå®ƒç¬¦åˆ**å¯è¿­ä»£åè®®**å’Œ**è¿­ä»£å™¨åè®®**ï¼Œæ—¢æ˜¯è¿­ä»£å™¨ä¹Ÿæ˜¯å¯è¿­ä»£å¯¹è±¡ï¼Œå¯ä»¥è°ƒç”¨ `next` æ–¹æ³•ï¼Œä½†å®ƒä¸æ˜¯å‡½æ•°ï¼Œæ›´ä¸æ˜¯æ„é€ å‡½æ•°

ç”Ÿæˆå™¨å‡½æ•°ï¼ˆGeneratorFunctionï¼‰ï¼š

> function\* name([param[, param[, ... param]]]) { statements }
>
> - nameï¼šå‡½æ•°å
> - paramï¼šå‚æ•°
> - statementsï¼šjs è¯­å¥

è°ƒç”¨ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°å¹¶ä¸ä¼šé©¬ä¸Šæ‰§è¡Œå®ƒé‡Œé¢çš„è¯­å¥ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªè¿™ä¸ªç”Ÿæˆå™¨çš„è¿­ä»£å™¨å¯¹è±¡ï¼Œå½“è¿™ä¸ªè¿­ä»£å™¨çš„ `next()` æ–¹æ³•è¢«é¦–æ¬¡ï¼ˆåç»­ï¼‰è°ƒç”¨æ—¶ï¼Œå…¶å†…çš„è¯­å¥ä¼šæ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ªï¼ˆåç»­ï¼‰å‡ºç° `yield` çš„ä½ç½®ä¸ºæ­¢ï¼ˆè®©æ‰§è¡Œå¤„äº**æš‚åœçŠ¶**ï¼‰ï¼Œ`yield` åç´§è·Ÿè¿­ä»£å™¨è¦è¿”å›çš„å€¼ã€‚æˆ–è€…å¦‚æœç”¨çš„æ˜¯ `yield*`ï¼ˆå¤šäº†ä¸ªæ˜Ÿå·ï¼‰ï¼Œåˆ™è¡¨ç¤ºå°†æ‰§è¡Œæƒç§»äº¤ç»™å¦ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°ï¼ˆå½“å‰ç”Ÿæˆå™¨**æš‚åœæ‰§è¡Œ**ï¼‰ï¼Œè°ƒç”¨ `next()` ï¼ˆå†å¯åŠ¨ï¼‰æ–¹æ³•æ—¶ï¼Œå¦‚æœä¼ å…¥äº†å‚æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªå‚æ•°ä¼šä½œä¸º**ä¸Šä¸€æ¡æ‰§è¡Œçš„ `yield` è¯­å¥çš„è¿”å›å€¼**ï¼Œä¾‹å¦‚ï¼š

```javascript
function* another() {
  yield 'äººæœˆç¥è¯';
}
function* gen() {
  yield* another(); // ç§»äº¤æ‰§è¡Œæƒ
  const a = yield 'hello';
  const b = yield a; // a='world' æ˜¯ next('world') ä¼ å‚èµ‹å€¼ç»™äº†ä¸Šä¸€ä¸ª yidle 'hello' çš„å·¦å€¼
  yield b; // b=ï¼ æ˜¯ next('ï¼') ä¼ å‚èµ‹å€¼ç»™äº†ä¸Šä¸€ä¸ª yidle a çš„å·¦å€¼
}
const g = gen();
g.next(); // {value: "äººæœˆç¥è¯", done: false}
g.next(); // {value: "hello", done: false}
g.next('world'); // {value: "world", done: false} å°† 'world' èµ‹ç»™ä¸Šä¸€æ¡ yield 'hello' çš„å·¦å€¼ï¼Œå³æ‰§è¡Œ a='world'ï¼Œ
g.next('!'); // {value: "!", done: false} å°† '!' èµ‹ç»™ä¸Šä¸€æ¡ yield a çš„å·¦å€¼ï¼Œå³æ‰§è¡Œ b='!'ï¼Œè¿”å› b
g.next(); // {value: undefined, done: false}
```

çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šé—®ï¼Œ`Generator` å’Œ `callback` æœ‰å•¥å…³ç³»ï¼Œå¦‚ä½•å¤„ç†å¼‚æ­¥å‘¢ï¼Ÿå…¶å®äºŒè€…æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œæˆ‘ä»¬åªæ˜¯é€šè¿‡ä¸€äº›æ–¹å¼å¼ºè¡Œçš„å®ƒä»¬äº§ç”Ÿäº†å…³ç³»ï¼Œæ‰ä¼šæœ‰ `Generator` å¤„ç†å¼‚æ­¥

æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ `Generator` çš„æœ¬è´¨ï¼Œæš‚åœï¼Œå®ƒä¼šè®©ç¨‹åºæ‰§è¡Œåˆ°æŒ‡å®šä½ç½®å…ˆæš‚åœï¼ˆ`yield`ï¼‰ï¼Œç„¶åå†å¯åŠ¨ï¼ˆ`next`ï¼‰ï¼Œå†æš‚åœï¼ˆ`yield`ï¼‰ï¼Œå†å¯åŠ¨ï¼ˆ`next`ï¼‰ï¼Œè€Œè¿™ä¸ªæš‚åœå°±å¾ˆå®¹æ˜“è®©å®ƒå’Œå¼‚æ­¥æ“ä½œäº§ç”Ÿè”ç³»ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å¤„ç†å¼‚æ­¥æ—¶ï¼šå¼€å§‹å¼‚æ­¥å¤„ç†ï¼ˆç½‘ç»œæ±‚æƒ…ã€IO æ“ä½œï¼‰ï¼Œç„¶åæš‚åœä¸€ä¸‹ï¼Œç­‰å¤„ç†å®Œäº†ï¼Œå†è¯¥å¹²å˜›å¹²å˜›ã€‚ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ**js æ˜¯å•çº¿ç¨‹çš„ï¼ˆåˆé‡å¤äº†ä¸‰éï¼‰**ï¼Œå¼‚æ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œcallback è¿˜æ˜¯ callbackï¼Œä¸ä¼šå› ä¸º `Generator` è€Œæœ‰ä»»ä½•æ”¹å˜

ä¸‹é¢æ¥çœ‹çœ‹ï¼Œç”¨ `Generator` å®ç°å¼‚æ­¥ï¼š

```javascript
const promisify = require('util').promisify;
const path = require('path');
const fs = require('fs');
const readFile = promisify(fs.readFile);

const gen = function*() {
  const res1 = yield readFile(path.resolve(__dirname, '../data/a.json'), { encoding: 'utf8' });
  console.log(res1);
  const res2 = yield readFile(path.resolve(__dirname, '../data/b.json'), { encoding: 'utf8' });
  console.log(res2);
};

const g = gen();

const g1 = g.next();
console.log('g1:', g1);

g1.value
  .then(res1 => {
    console.log('res1:', res1);
    const g2 = g.next(res1);
    console.log('g2:', g2);
    g2.value
      .then(res2 => {
        console.log('res2:', res2);
        g.next(res2);
      })
      .catch(err2 => {
        console.log(err2);
      });
  })
  .catch(err1 => {
    console.log(err1);
  });
// g1: { value: Promise { <pending> }, done: false }
// res1: {
//   "a": 1
// }

// {
//   "a": 1
// }

// g2: { value: Promise { <pending> }, done: false }
// res2: {
//   "b": 2
// }

// {
//   "b": 2
// }
```

ä»¥ä¸Šä»£ç æ˜¯ `Generator` å’Œ `callback` ç»“åˆå®ç°çš„å¼‚æ­¥ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä»ç„¶éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ `.then` å±‚å±‚æ·»åŠ å›è°ƒï¼Œä½†ç”±äº `next()` æ–¹æ³•è¿”å›å¯¹è±¡ `{value: xxx,done: true/false}` æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç®€åŒ–å®ƒï¼Œå†™ä¸€ä¸ªè‡ªåŠ¨æ‰§è¡Œå™¨ï¼š

```javascript
const promisify = require('util').promisify;
const path = require('path');
const fs = require('fs');
const readFile = promisify(fs.readFile);

function run(gen) {
  const g = gen();
  function next(data) {
    const res = g.next(data);
    // æ·±åº¦é€’å½’ï¼Œåªè¦ `Generator` å‡½æ•°è¿˜æ²¡æ‰§è¡Œåˆ°æœ€åä¸€æ­¥ï¼Œ`next` å‡½æ•°å°±è°ƒç”¨è‡ªèº«
    if (res.done) return res.value;
    res.value.then(function(data) {
      next(data);
    });
  }
  next();
}
run(function*() {
  const res1 = yield readFile(path.resolve(__dirname, '../data/a.json'), { encoding: 'utf8' });
  console.log(res1);
  // {
  //   "a": 1
  // }
  const res2 = yield readFile(path.resolve(__dirname, '../data/b.json'), { encoding: 'utf8' });
  console.log(res2);
  // {
  //   "b": 2
  // }
});
```

è¯´äº†è¿™ä¹ˆå¤šï¼Œæ€ä¹ˆè¿˜æ²¡æœ‰åˆ° `async/await`ï¼Œå®¢å®˜åˆ«æ€¥ï¼Œé©¬ä¸Šæ¥äº†ï¼ˆå…¶å®æˆ‘å·²ç»æ¼äº†ä¸€äº›å†…å®¹æ²¡è¯´ï¼šPromise å’Œ callback çš„å…³ç³»ï¼Œthunk å‡½æ•°ï¼Œco åº“ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å» google ä¸€ä¸‹ï¼Œyuanyifeng è€å¸ˆè®²çš„[es6 å…¥é—¨](http://es6.ruanyifeng.com)éå¸¸æ£’ï¼Œæˆ‘æ—¶ä¸æ—¶çš„éƒ½ä¼šå»çœ‹ä¸€çœ‹ï¼‰

é¦–å…ˆï¼Œ`async/await` æ˜¯ `Generator` çš„è¯­æ³•ç³–ï¼Œä¸Šé¢*æˆ‘æ˜¯åˆ†å‰²çº¿*ä¸‹çš„ç¬¬ä¸€å¥å·²ç»è®²è¿‡ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹äºŒè€…çš„å¯¹æ¯”ï¼š

```javascript
// Generator
run(function*() {
  const res1 = yield readFile(path.resolve(__dirname, '../data/a.json'), { encoding: 'utf8' });
  console.log(res1);
  const res2 = yield readFile(path.resolve(__dirname, '../data/b.json'), { encoding: 'utf8' });
  console.log(res2);
});

// async/await
const readFile = async ()=>{
  const res1 = await readFile(path.resolve(__dirname, '../data/a.json'), { encoding: 'utf8' });
  console.log(res1);
  const res2 = await readFile(path.resolve(__dirname, '../data/b.json'), { encoding: 'utf8' });
  console.log(res2);
  return 'done'ï¼›
}
const res = readFile();
```

å¯ä»¥çœ‹åˆ°ï¼Œ`async function` ä»£æ›¿äº† `function*`ï¼Œ`await` ä»£æ›¿äº† `yield`ï¼ŒåŒæ—¶ä¹Ÿæ— éœ€è‡ªå·±æ‰‹å†™ä¸€ä¸ªè‡ªåŠ¨æ‰§è¡Œå™¨ `run` äº†

ç°åœ¨å†æ¥çœ‹çœ‹`async/await` çš„ç‰¹ç‚¹ï¼š

- å½“ `await` åé¢è·Ÿçš„æ˜¯ Promise å¯¹è±¡æ—¶ï¼Œæ‰ä¼šå¼‚æ­¥æ‰§è¡Œï¼Œå…¶å®ƒç±»å‹çš„æ•°æ®ä¼šåŒæ­¥æ‰§è¡Œ
- æ‰§è¡Œ `const res = readFile();` è¿”å›çš„ä»ç„¶æ˜¯ä¸ª Promise å¯¹è±¡ï¼Œä¸Šé¢ä»£ç ä¸­çš„ `return 'done';` ä¼šç›´æ¥è¢«ä¸‹é¢ `then` å‡½æ•°æ¥æ”¶åˆ°

```javascript
res.then(data => {
  console.log(data); // done
});
```

å•Šï¼Œç»ˆäºå®Œäº†ï¼Œä¸€ä¸ª `async-await` è¿å¸¦å‡ºæ¥è¿™ä¹ˆå¤šçŸ¥è¯†ç‚¹ï¼Œä»¥åé¢è¯•è¢«é—®åˆ°å®ƒçš„åŸç†æ—¶ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©åˆ°ä½ 

ã€å‚è€ƒã€‘ï¼š

1. <https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Iteration_protocols#%E5%8F%AF%E8%BF%AD%E4%BB%A3%E5%8D%8F%E8%AE%AE>
2. <http://es6.ruanyifeng.com/#docs/iterator>
3. <http://es6.ruanyifeng.com/#docs/async>

===ğŸ§ğŸ§ _æ–‡ä¸­ä¸è¶³ï¼Œæ¬¢è¿æŒ‡æ­£_ ğŸ¤ªğŸ¤ª===
