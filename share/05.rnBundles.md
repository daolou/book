# RN æ‹†åŒ… demoï¼ˆåŸºäº react-native bundle å‘½ä»¤ï¼‰

> æˆ‘ä¸æ‡‚åŸç”Ÿï¼Œåªåš js éƒ¨åˆ†ï¼Œæœ‰æ‡‚è¿™æ–¹é¢çš„å¤§ä½¬ï¼Œä¹Ÿå¯ä»¥è¡¥å……åŸç”Ÿéƒ¨åˆ†
>
> ç¯å¢ƒï¼š
>
> macOS: 10.14.4;
>
> node(nvm): 10.15.3;
>
> react-native-cli: 2.0.1;
>
> react-native: 0.60.0;

## ç›®å½•ç»“æ„

```zsh
.
â”œâ”€â”€ .babelrc
â”œâ”€â”€ .buckconfig
â”œâ”€â”€ .editorconfig
â”œâ”€â”€ .eslintrc.js
â”œâ”€â”€ .flowconfig
â”œâ”€â”€ .git
â”œâ”€â”€ .gitattributes
â”œâ”€â”€ .gitignore
â”œâ”€â”€ .patch (å­˜æ”¾å¢é‡æ–‡ä»¶)
â”œâ”€â”€ .watchmanconfig
â”œâ”€â”€ README.md
â”œâ”€â”€ __tests__
â”œâ”€â”€ android (åŸç”Ÿä»£ç ï¼ŒåŸç”Ÿå¼€å‘ç»´æŠ¤)
â”œâ”€â”€ app.json
â”œâ”€â”€ babel.config.js
â”œâ”€â”€ bundles (bundleè¾“å‡ºç›®å½•)
â”œâ”€â”€ business.config.js (æ‰“åŒ…ä¸šåŠ¡æ¨¡å—çš„é…ç½®)
â”œâ”€â”€ common.config.js (æ‰“åŒ…å…¬å…±åŸºç¡€æ¨¡å—çš„é…ç½®)
â”œâ”€â”€ common.js (å…¬å…±åŸºç¡€æ¨¡å—çš„å…¥å£æ–‡ä»¶)
â”œâ”€â”€ config (é…ç½®æ–‡ä»¶ç›®å½•)
â”œâ”€â”€ index.js (å¼€å‘æ¨¡å¼çš„å…¥å£æ–‡ä»¶)
â”œâ”€â”€ ios (åŸç”Ÿä»£ç ï¼ŒåŸç”Ÿå¼€å‘ç»´æŠ¤)
â”œâ”€â”€ jsconfig.json
â”œâ”€â”€ package.json
â”œâ”€â”€ scripts (è„šæœ¬ç›®å½•)
â”œâ”€â”€ src (å‰ç«¯é¡µé¢ï¼Œå‰ç«¯å¼€å‘ç»´æŠ¤)
â”œâ”€â”€ upload (å­˜æ”¾éœ€ä¸Šä¼ æœåŠ¡å™¨çš„æ–‡ä»¶)
â””â”€â”€ yarn.lock
```

### js éƒ¨åˆ†

é€šå¸¸ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªå¤§çš„ jsbundle åŒ…æ‹†åˆ†ä¸ºåŸºç¡€åŒ…å’Œä¸šåŠ¡åŒ…ï¼š
åŸºç¡€åŒ…ï¼šæ‰¿æ¥ reactï¼Œreact-native å’Œä¸€äº›ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œè¿™äº›ä¾èµ–ä¸€èˆ¬ä¸ä¼šæœ‰å¤ªå¤šå˜åŠ¨ï¼ˆæ¯•ç«Ÿ rn å¼€å‘å¤§éƒ½é”å®šä¾èµ–ç‰ˆæœ¬ï¼‰
ä¸šåŠ¡åŒ…ï¼šæ‰¿æ¥ä¸šåŠ¡æ¨¡å—ï¼Œä¸€èˆ¬æœ‰å¤šä¸ªæ¨¡å—ï¼ˆæ¯”å¦‚ç™»å½•æ¨¡å—ï¼Œä¸ªäººä¸­å¿ƒæ¨¡å—ï¼Œã€‚ã€‚ã€‚ï¼‰
åŸºäº `react-native bundle` å‘½ä»¤æ‹†åŒ…(å…¶å®æ˜¯åŸºäº[metro](https://facebook.github.io/metro/docs/en/configuration))
å‘½ä»¤ä¸ºæˆ‘ä»¬æä¾›äº† `--config` å‚æ•°ï¼Œè®©æˆ‘ä»¬å¯ä»¥è‡ªå·±æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼ˆcommon å’Œ businessï¼‰æ¥åˆ†åˆ«è¿›è¡Œæ‰“åŒ…äº†ï¼Œ
`react-native bundle [å…¶ä»–é…ç½®] --config common`ï¼šæ‰“å…¬å…±åŸºç¡€åŒ…
`react-native bundle [å…¶ä»–é…ç½®] --config business`ï¼šæ‰“ä¸šåŠ¡åŒ…
ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ metro çš„è¿™ä¸ª config æ–‡ä»¶ï¼š

```js
module.exports = {
  resolver: {
    /* resolver options */
  },
  transformer: {
    /* transformer options */
  },
  serializer: {
    /* serializer options */
  },
  server: {
    /* server options */
  },

  /* general options */
};
```

å¯¹äºæ‹†åŒ…æˆ‘ä»¬èƒ½ç”¨åˆ°çš„å°±æ˜¯ `serializer` ä¸­çš„ `createModuleIdFactory` å’Œ `postProcessBundleSourcemap` è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š

- `createModuleIdFactory`ï¼š

  - Used to generate the module id for `require` statements.
  - ç”¨æ¥ç”Ÿæˆæ¨¡å— id çš„

- `postProcessBundleSourcemap`ï¼š
  - An optional function that can modify the code and source map of the bundle before it is written. Applied once for the entire bundle.
  - å¯é€‰å‡½æ•°ï¼Œå¯ä»¥åœ¨å†™å…¥ä¹‹å‰ä¿®æ”¹åŒ…çš„ä»£ç å’Œæºæ˜ å°„ï¼Œç”¨æ¥è¿‡æ»¤æ˜¯å¦ç¼–è¯‘

#### 1. åœ¨é¡¹ç›®`config`ç›®å½•æ–°å»º `createModuleIdFactory.js` å’Œ `postProcessBundleSourcemap.js`

`createModuleIdFactory.js`:

```js
/**
 * ç”Ÿæˆæ¨¡å—Id
 * åŸºç¡€æ‰“åŒ…é…ç½®
 */
const path = require('path');
const pathSep = path.posix.sep;

function createModuleIdFactory() {
  const projectRootPath = process.cwd(); //è·å–å‘½ä»¤è¡Œæ‰§è¡Œçš„ç›®å½•

  return modulePath => {
    // console.log(modulePath)
    let moduleName = '';
    if (modulePath.indexOf(`node_modules${pathSep}react-native${pathSep}Libraries${pathSep}`) > 0) {
      //è¿™é‡Œæ˜¯å»é™¤è·¯å¾„ä¸­çš„'node_modules/react-native/Libraries/â€˜ä¹‹å‰ï¼ˆåŒ…æ‹¬ï¼‰çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥å‡å°‘åŒ…å¤§å°ï¼Œå¯æœ‰å¯æ— 
      moduleName = modulePath.substr(modulePath.lastIndexOf(pathSep) + 1);
    } else if (modulePath.indexOf(projectRootPath) === 0) {
      //è¿™é‡Œæ˜¯å–ç›¸å¯¹è·¯å¾„ï¼Œä¸è¿™ä¹ˆå¼„çš„è¯å°±ä¼šæ‰“å‡º_user_smallnew_works_....è¿™ä¹ˆé•¿çš„è·¯å¾„ï¼Œè¿˜ä¼šæŠŠè®¡ç®—æœºåæ‰“è¿›å»
      moduleName = modulePath.substr(projectRootPath.length + 1);
    }
    moduleName = moduleName.replace('.js', ''); //js pngå­—ç¬¦ä¸²æ²¡å¿…è¦æ‰“è¿›å»
    moduleName = moduleName.replace('.png', '');
    let regExp = pathSep === '\\' ? new RegExp('\\\\', 'gm') : new RegExp(pathSep, 'gm');
    moduleName = moduleName.replace(regExp, '_'); //æŠŠpathä¸­çš„/æ¢æˆä¸‹åˆ’çº¿(é€‚é…Windowså¹³å°è·¯å¾„é—®é¢˜)

    // console.log(moduleName);

    return moduleName;
  };
}
module.exports = createModuleIdFactory;
```

`postProcessBundleSourcemap.js`:

```js
// ä¸šåŠ¡ä»£ç 
const path = require('path');
const pathSep = path.posix.sep;
// è¿™é‡Œç®€å•æš´åŠ›åœ°å§precludeå’Œnode_modulesç›®å½•ä¸‹çš„æ–‡ä»¶å…¨éƒ¨è¿‡æ»¤æ‰ï¼Œåªæ‰“è‡ªå·±å†™çš„ä»£ç ã€‚
// åªæœ‰è‡ªå·±å†™çš„æ‰ç®—æ˜¯ä¸šåŠ¡ä»£ç 
function postProcessModulesFilter(module) {
  //è¿”å›falseåˆ™è¿‡æ»¤ä¸ç¼–è¯‘

  if (module.path.indexOf('__prelude__') >= 0) {
    return false;
  }
  if (module.path.indexOf(pathSep + 'node_modules' + pathSep) > 0) {
    if (`js${pathSep}script${pathSep}virtual` === module.output[0].type) {
      return true;
    }
    if (
      module.path.indexOf(
        `${pathSep}node_modules${pathSep}@babel${pathSep}runtime${pathSep}helpers`
      ) > 0
    ) {
      //æ·»åŠ è¿™ä¸ªåˆ¤æ–­ï¼Œè®©@babel/runtimeæ‰“è¿›åŒ…å»
      return true;
    }
    return false;
  }
  return true;
}
module.exports = postProcessModulesFilter;
```

#### 2. åœ¨é¡¹ç›®æ ¹ç›®å½•æ–°å»º `common.config.js` å’Œ `business.config.js`

`common.config.js`:

```js
// åŸºç¡€æ‰“åŒ…é…ç½®
const createModuleIdFactory = require('./config/createModuleIdFactory');

module.exports = {
  transformer: {
    getTransformOptions: async () => ({
      transform: {
        experimentalImportSupport: true,
        inlineRequires: false,
      },
    }),
  },
  serializer: {
    // æ‰€æœ‰æ¨¡å—ä¸€ç»è½¬æ¢å°±ä¼šè¢«åºåˆ—åŒ–ï¼ŒSerializationä¼šç»„åˆè¿™äº›æ¨¡å—æ¥ç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ªåŒ…ï¼ŒåŒ…å°±æ˜¯å°†æ¨¡å—ç»„åˆæˆä¸€ä¸ªJavaScriptæ–‡ä»¶çš„åŒ…ã€‚
    // å‡½æ•°ä¼ å…¥çš„æ˜¯ä½ è¦æ‰“åŒ…çš„moduleæ–‡ä»¶çš„ç»å¯¹è·¯å¾„è¿”å›çš„æ˜¯è¿™ä¸ªmoduleçš„id
    // é…ç½®createModuleIdFactoryè®©å…¶æ¯æ¬¡æ‰“åŒ…éƒ½moduleä»¬ä½¿ç”¨å›ºå®šçš„id(è·¯å¾„ç›¸å…³)
    createModuleIdFactory: createModuleIdFactory,
    /* serializer options */
  },
};
```

`business.config.js`:

```js
// ä¸šåŠ¡ä»£ç 
const createModuleIdFactory = require('./config/createModuleIdFactory');
const postProcessModulesFilter = require('./config/postProcessModulesFilter');

module.exports = {
  transformer: {
    getTransformOptions: async () => ({
      transform: {
        experimentalImportSupport: true,
        inlineRequires: false,
      },
    }),
  },
  serializer: {
    // å‡½æ•°ä¼ å…¥çš„æ˜¯ä½ è¦æ‰“åŒ…çš„moduleæ–‡ä»¶çš„ç»å¯¹è·¯å¾„è¿”å›çš„æ˜¯è¿™ä¸ªmoduleçš„id
    createModuleIdFactory: createModuleIdFactory,
    // A filter function to discard specific modules from the output.
    // æ•°ä¼ å…¥çš„æ˜¯moduleä¿¡æ¯ï¼Œè¿”å›æ˜¯booleanå€¼ï¼Œå¦‚æœæ˜¯falseå°±è¿‡æ»¤ä¸æ‰“åŒ…
    // é…ç½®processModuleFilterè¿‡æ»¤åŸºç¡€åŒ…æ‰“å‡ºä¸šåŠ¡åŒ…
    processModuleFilter: postProcessModulesFilter,
    /* serializer options */
  },
};
```

#### 3. åœ¨é¡¹ç›®`config`ç›®å½•æ–°å»º `index.js`ï¼Œç”¨äºè®¾ç½®æ‰“åŒ…é…ç½®

`index.js`:

```js
// åŸºç¡€æ‰“åŒ…é…ç½®
/**
 * version - js bundleç‰ˆæœ¬ï¼Œåˆå§‹å€¼æ˜¯1ï¼Œæ¯æ¬¡æ›´æ–°è¯·æ‰‹åŠ¨åŠ 1
 * common - å…¬å…±åŸºç¡€åŒ…bundle
 * bundles - ä¸šåŠ¡æ¨¡å—åŸºç¡€åŒ…bundle
 * {

    "animate": true, // ioså¹³å°ä¼šä½¿ç”¨, å½“ä»Aé¡µé¢è½¬åœºåˆ°Bé¡µé¢çš„æ—¶å€™,æ§åˆ¶[self.navigationControllersetNavigationBarHidden: animated:];ä¸­çš„animate
    "statusBgColor": "#408EF5", //å¯¼èˆªçŠ¶æ€æ çš„èƒŒæ™¯è‰²
    "type": "push", // è¿›å…¥rnçš„å½¢å¼(2ç§, pushå’Œpresent)

    "source": "Login", // ç”¨äºæ‹†åŒ…æ‰“åŒ…æ˜¯çš„å…¥å£entry_file
    "moduleName": "platform", // æ¨¡å—åç§°,å’Œ AppRegistry.registerComponent('platform', () => App);ä¸€ä¸€å¯¹åº”
    "bundleName": "platform.bundle" // æ­¤æ¨¡å—æ‰“åŒ…å‡ºæ¥çš„bundleåç§°, ç”Ÿäº§ç¯å¢ƒä½¿ç”¨
    }
*/
module.exports = {
  version: 1,
  common: {
    moduleName: 'platform',
    bundleName: 'platform.bundle',
  },
  bundles: [
    {
      animate: false,
      statusBgColor: '#408EF5',
      type: 'push',
      source: 'mine',
      moduleName: 'rbd_mine',
      bundleName: 'rbd_mine.bundle',
    },
    {
      animate: true,
      statusBgColor: '#ffffff',
      type: 'push',
      source: 'discover',
      moduleName: 'rbd_discover',
      bundleName: 'rbd_discover.bundle',
    },
  ],
};
```

#### 4. ç¼–å†™`node`è„šæœ¬ï¼Œè¿›è¡Œæ‰“åŒ…ï¼ŒåŒ…å«çƒ­æ›´æ–°ï¼ˆæ–‡ä»¶çº§åˆ«å¢é‡å‡çº§ï¼‰

æ³¨ï¼š`<>` è¡¨ç¤ºå¿…é€‰ï¼Œ`[]` è¡¨ç¤ºå¯é€‰ï¼Œ-v é»˜è®¤å– config/index.js çš„ version
ç›®å‰æ˜¯æ–‡ä»¶çº§åˆ«å¢é‡å‡çº§ï¼Œä¸‹ä¸€æ­¥æ˜¯å†…å®¹çº§åˆ«å¢é‡å‡çº§ï¼ˆ[diff-match-patch](https://github.com/google/diff-match-patch)ï¼‰
`package.json` å¢åŠ 

```json
"bin": {
  "rn": "./scripts/command.js"
},
```

åœ¨é¡¹ç›®æ‰§è¡Œ `npm link`,ä¹‹åå°±å¯ä»¥ç”¨ `rn` è„šæ‰‹æ¶å‘½ä»¤äº†ï¼š

- `rn pack <platform> <type> [-v version]`: æ‰“åŒ… android/ios çš„ version ç‰ˆæœ¬çš„ common/business åŒ…ï¼Œå¹¶å‹ç¼©è‡³ upload ç›®å½•
- `rn patch <platform> [-v version]`: æ‰“åŒ… android/ios çš„ version ç‰ˆæœ¬çš„å¢é‡åŒ…ï¼Œå¹¶å‹ç¼©è‡³ upload ç›®å½•
- `rn hash <target> [-v version]`: target å¯ä»¥æ˜¯æ–‡ä»¶è·¯å¾„(æ­¤æ—¶æ— éœ€-v å‚æ•°)ã€iosã€android,è·å–æ–‡ä»¶æŒ‡çº¹(md5)

è„šæœ¬å†…å®¹æœ‰ç‚¹å¤šï¼Œè¯·ç›´æ¥çœ‹ä»£ç å§: [command](https://github.com/Mr-jiangzhiguo/rn-bundles-demo/blob/master/scripts/command.js)

ä¸ºäº†ä¿è¯ jsbundle ç‰ˆæœ¬å’ŒåŸç”Ÿ nation ç‰ˆæœ¬ä¿æŒåŒæ­¥ï¼Œéœ€è¦å‰ç«¯å’ŒåŸç”Ÿäººå‘˜å…±åŒç»´æŠ¤ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚æ”¾åˆ° firebaseï¼š
![remote-config](https://user-gold-cdn.xitu.io/2019/7/10/16bdaccac3b8cd9d?w=1596&h=802&f=png&s=132655)

### Android éƒ¨åˆ†

### Ios éƒ¨åˆ†

é™„ï¼š[repo](https://github.com/Mr-jiangzhiguo/rn-bundles-demo)

===ğŸ§ğŸ§ æ–‡ä¸­ä¸è¶³ï¼Œæ¬¢è¿æŒ‡æ­£ ğŸ¤ªğŸ¤ª===
