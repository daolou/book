# Jenkinsï¼ˆBuild great things at any scaleï¼‰

<a href="https://github.com/daolou/book" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

## what is Jenkins

> [Jenkins](https://jenkins.io)æ˜¯å¼€æº CIï¼ˆContinuous Integrationï¼šæŒç»­é›†æˆï¼‰&CDï¼ˆContinuous Deliveryï¼šæŒç»­äº¤ä»˜ï¼‰ è½¯ä»¶é¢†å¯¼è€…ï¼Œ æä¾›è¶…è¿‡ 1000 ä¸ªæ’ä»¶æ¥æ”¯æŒæ„å»ºã€éƒ¨ç½²ã€è‡ªåŠ¨åŒ–ï¼Œ æ»¡è¶³ä»»ä½•é¡¹ç›®çš„éœ€è¦ï¼Œæ”¯æŒå„ç§è¿è¡Œæ–¹å¼ï¼Œå¯é€šè¿‡ç³»ç»ŸåŒ…, Docker æˆ–è€…é€šè¿‡ä¸€ä¸ªç‹¬ç«‹çš„ Java ç¨‹åºã€‚

**åŸç†ï¼š** çœ‹å›¾ï¼ˆ[ç”»å›¾å·¥å…·](https://www.draw.io)ï¼‰
![img](https://user-gold-cdn.xitu.io/2019/4/30/16a6e0bf7f521052?w=1714&h=1032&f=jpeg&s=240501)

## why use Jenkins

- **æŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜**ï¼šä½œä¸ºä¸€ä¸ªå¯æ‰©å±•çš„è‡ªåŠ¨åŒ–æœåŠ¡å™¨ï¼ŒJenkins å¯ä»¥ç”¨ä½œç®€å•çš„ CI æœåŠ¡å™¨ï¼Œæˆ–è€…å˜æˆä»»ä½•é¡¹ç›®çš„è¿ç»­äº¤ä»˜ä¸­å¿ƒã€‚
- **ç®€æ˜“å®‰è£…**ï¼šJenkins æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åŸºäº Java çš„ç¨‹åºï¼Œå¯ä»¥ç«‹å³è¿è¡Œï¼ŒåŒ…å« Windowsï¼ŒMac OS X å’Œå…¶ä»–ç±» Unix æ“ä½œç³»ç»Ÿã€‚
- **é…ç½®ç®€å•**ï¼šJenkins å¯ä»¥é€šè¿‡å…¶ç½‘é¡µç•Œé¢è½»æ¾è®¾ç½®å’Œé…ç½®ï¼Œå…¶ä¸­åŒ…æ‹¬å³æ—¶é”™è¯¯æ£€æŸ¥å’Œå†…ç½®å¸®åŠ©ã€‚
- **æ’ä»¶**ï¼šé€šè¿‡æ›´æ–°ä¸­å¿ƒä¸­çš„ 1000 å¤šä¸ªæ’ä»¶ï¼ŒJenkins é›†æˆäº†æŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜å·¥å…·é“¾ä¸­å‡ ä¹æ‰€æœ‰çš„å·¥å…·ã€‚
- **æ‰©å±•**ï¼šJenkins å¯ä»¥é€šè¿‡å…¶æ’ä»¶æ¶æ„è¿›è¡Œæ‰©å±•ï¼Œä»è€Œä¸º Jenkins å¯ä»¥åšçš„äº‹æä¾›å‡ ä¹æ— é™çš„å¯èƒ½æ€§ã€‚
- **åˆ†å¸ƒå¼**ï¼šJenkins å¯ä»¥è½»æ¾åœ°åœ¨å¤šå°æœºå™¨ä¸Šåˆ†é…å·¥ä½œï¼Œå¸®åŠ©æ›´å¿«é€Ÿåœ°è·¨å¤šä¸ªå¹³å°æ¨åŠ¨æ„å»ºï¼Œæµ‹è¯•å’Œéƒ¨ç½²ã€‚

## Install

ç¯å¢ƒï¼šubuntuã€dockerã€git

```shell
$ cat /etc/issue
Ubuntu 16.04.6 LTS \n \l
```

> åŸºäº dockerï¼Œä¸ç†Ÿæ‚‰çš„å¯ä»¥å…ˆçœ‹çœ‹æˆ‘çš„ä¸Šä¸€ç¯‡[å‰ç«¯ä¹‹è·¯ï¼šç´§è·Ÿæ½®æµï¼Œdocker ç®€å•åº”ç”¨](https://juejin.im/post/5c79f1a16fb9a049fc043b7f)

- æ‹‰å»é•œåƒ
  - `$ docker pull jenkinsci/blueocean`
- æ ¹æ®æ‹‰å–çš„ Jenkins é•œåƒå¯åŠ¨ä¸€ä¸ªå®¹å™¨

  ```shell
    $ docker run \
    -d \
    --name jenkins \
    -u root \
    -p 49001:8080 \
    -v /var/jenkins_home:/var/jenkins_home \
    -v /var/jenkins_ssh:/root/.ssh \
    -v /var/run/docker.sock:/var/run/docker.sock \
    jenkinsci/blueocean

  ```

  è§£é‡Šï¼š

  - `-d`ï¼šå®ˆæŠ¤æ¨¡å¼ï¼Œåœ¨åå°è¿è¡Œã€‚
  - `-p`ï¼šç«¯å£æ˜ å°„ï¼Œ49001 æ˜¯æœåŠ¡å™¨ç«¯å£ï¼ˆå¯æ ¹æ®è‡ªå·±æƒ…å†µæ›´æ”¹ï¼Œåˆ«å¿˜è®°å®‰å…¨ç»„å¼€æ”¾ç«¯å£ï¼‰ï¼Œ8080 æ˜¯å®¹å™¨ç«¯å£ï¼ˆjenkins ç¨‹åºé»˜è®¤ç«¯å£ï¼‰ã€‚
  - `-v`ï¼šæŒ‚è½½æ•°æ®å·ï¼Œ`/var/jenkins_home:/var/jenkins_home`ï¼šå°† Jenkins ç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœºï¼›`/var/jenkins_ssh:/root/.ssh`ï¼šå°† Jenkins çš„ ssh æŒ‚è½½åˆ°å®¿ä¸»æœºï¼Œå¤‡ä»½ç”¨ï¼Œé˜²æ­¢é‡å¯åä¸¢å¤±æ‰¾ä¸åˆ°ã€‚

- æŸ¥çœ‹å®¹å™¨è¿è¡Œæƒ…å†µï¼š

  ```shell
    $ docker ps
    CONTAINER ID      IMAGE                COMMAND                  CREATED        STATUS           PORTS                                NAMES
    08a54d4a804a      jenkinsci/blueocean  "/sbin/tini -- /usr/â€¦"   7 days ago     Up 7 days        50000/tcp, 0.0.0.0:49001->8080/tcp   jenkins
  ```

  é™„å›¾ï¼š![img](https://user-gold-cdn.xitu.io/2019/4/30/16a6e288ba0341c7?w=2878&h=336&f=jpeg&s=110383)

  ä»¥ä¸Šè¯´æ˜å·²æˆåŠŸï¼Œè‹¥å®¹å™¨æ„å¤–é€€å‡ºï¼Œå»æ‰-d å‚æ•°æ‰§è¡Œï¼ŒæŸ¥çœ‹ log æ¥æ’é”™ã€‚

- ç°åœ¨å¼€å§‹è®¾ç½® Jenkinsï¼Œåœ¨æµè§ˆå™¨è®¿é—® `ä½ çš„æœåŠ¡å™¨ip:49001`ï¼Œä¼šå‡ºç°ä»¥ä¸‹ç•Œé¢ï¼š
  ![img](https://user-gold-cdn.xitu.io/2019/4/30/16a6e38519eeb9ae?w=1726&h=1164&f=jpeg&s=142363)

  - æƒ³è¿›å…¥è¦å…ˆè§£é”ï¼Œå¯†ç å°±åœ¨ `/var/jenkins_home/secrets/initialAdminPassword` æ–‡ä»¶é‡Œï¼Œæ€ä¹ˆæŸ¥çœ‹å‘¢ï¼Ÿä¸¤ç§æ–¹æ¡ˆï¼š
    1. é¦–å…ˆè¦è¿›å…¥åˆšåˆšå¯åŠ¨çš„ jenkins å®¹å™¨é‡Œé¢ï¼Œæ‰§è¡Œ `$ docker exec -it jenkins bash`ï¼Œç„¶å `$ cat /var/jenkins_home/secrets/initialAdminPassword`ã€‚
    2. ç”±äºè¿è¡Œå®¹å™¨æ—¶ï¼Œå·²ç»å°† Jenkins ç›®å½•æŒ‚è½½åˆ°äº†å®¿ä¸»æœºï¼Œæ‰€ä»¥å¯ä»¥ä¸ç”¨è¿›å…¥å®¹å™¨ï¼Œç›´æ¥åœ¨å®¿ä¸»æœºæ‰§è¡Œ `$ sudo cat /var/jenkins_home/secrets/initialAdminPassword`ã€‚
  - å°†ä¸Šä¸€æ­¥çš„å¯†ç å¤åˆ¶åˆ°æµè§ˆå™¨ï¼Œç‚¹å‡» continue æŒ‰é’®è¿›è¡Œä¸‹ä¸€æ­¥ã€‚
    é™„å›¾ï¼š![img](https://user-gold-cdn.xitu.io/2019/4/30/16a6e414bb7ab025?w=1062&h=320&f=jpeg&s=42834)

  - å®‰è£…æ’ä»¶ï¼Œé€‰æ‹©æ¨èå®‰è£…å³å¯ã€‚

=================================================

ä¸Šé¢æ˜¯åŸºæœ¬çš„å®‰è£…ï¼Œæˆ‘ç”¨çš„æ˜¯æ—¶å€™å®˜æ–¹æ–‡æ¡£è¿˜æ˜¯è‹±æ–‡çš„ï¼Œç›®å‰æ”¯æŒä¸­æ–‡ï¼Œæƒ³äº†è§£æ›´è¯¦ç»†å†…å®¹ï¼Œè¯·å»[å®˜ç½‘](https://jenkins.io)ï¼Œä¸‹é¢å¼€å§‹æ•™å¤§å®¶æ–°å»ºä¸€ä¸ª **è‡ªç”±æ„å»ºçš„ä»»åŠ¡**ï¼ˆé‰´äºç›®å‰ç½‘ä¸Šå¤§éƒ½æ˜¯å¤šæœºæ•™ç¨‹ï¼Œå³é¡¹ç›®å’Œ jenkins ä¸åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œåˆè€ƒè™‘åˆ°å°ä¼™ä¼´ä»¬æ‰‹ä¸­å¯èƒ½åªæœ‰ä¸€å°è‡ªå·±çš„æœºå™¨ï¼Œæ‰€ä»¥æˆ‘ä¸‹é¢è¦è®²çš„æ˜¯ **å•æœºè¿è¡Œé¡¹ç›®å’Œ Jenkins**ï¼‰

=================================================

- æ‰“å¼€ `ip:49001`è¿›å…¥é¦–é¡µï¼Œç‚¹å‡»ç³»ç»Ÿç®¡ç†ï¼š
  ![img](https://user-gold-cdn.xitu.io/2019/4/30/16a6e53fb5c9bbfb?w=1391&h=1036&f=jpeg&s=169906)
- é¦–å…ˆç‚¹å‡»æ’ä»¶ç®¡ç†ï¼Œæœç´¢å¹¶å®‰è£…ä¸€ä¸‹æ’ä»¶ï¼ˆè‹¥å·²å®‰è£…åˆ—è¡¨å·²å­˜åœ¨å¯å¿½ç•¥ï¼‰ï¼š

  - Build Name Setter
  - Dingding[é’‰é’‰] Plugin
  - Build Timestamp Plugin
  - Git Parameter Plug-In
  - Publish Over SSH
  - SSH Slaves plugin
  - Timestamper

- ç„¶åç‚¹å‡»ç³»ç»Ÿè®¾ç½®ï¼š

  - æ‰¾åˆ° `Build Timestamp` (ä¸Šé¢çš„æ’ä»¶æä¾›çš„)ï¼Œè¿›è¡Œå¦‚ä¸‹è®¾ç½®ï¼š

    - Asia/Shanghai
    - yyyy-MM-dd-HH-mm-ss-SSS

    ![img](https://user-gold-cdn.xitu.io/2019/4/30/16a6e60c4e715bc7?w=1554&h=377&f=jpeg&s=85384)

  - æ‰¾åˆ° `Publish over SSH`ï¼Œè¿™ä¸ªç›¸å¯¹éº»çƒ¦äº›ï¼Œè¿›è¡Œå¦‚ä¸‹è®¾ç½®ï¼š

    ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a8670e74acf136?w=1566&h=315&f=jpeg&s=69980)

    è¯´æ˜ï¼š

    - Passphraseï¼šSSH çš„ passwordã€‚æœ‰ä¸¤ç§æƒ…å†µï¼š1. ä½¿ç”¨ username/password ç™»å½•æ—¶ä¸º username çš„ passwordï¼›2. ä½¿ç”¨ç§é’¥ç™»å½•æ—¶ä¸ºç§é’¥çš„ passwordã€‚
    - Path to keyï¼šSSH ç§é’¥çš„æ–‡ä»¶è·¯å¾„ã€‚å¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹\$JENKINS_HOME çš„ç›¸å¯¹è·¯å¾„ã€‚
    - Keyï¼šç§é’¥ï¼Œç§é’¥å¯¼å‡ºåçš„æ–‡æœ¬å†…å®¹ï¼Œå‡è®¾â€œKeyâ€å’Œâ€œPath to keyâ€éƒ½è®¾ç½®ï¼Œåˆ™â€œKeyâ€çš„ä¼˜å…ˆçº§è¾ƒé«˜ï¼Œæ­¤æ—¶â€œPassphraseâ€ä¸­è®¾ç½®çš„å†…å®¹åº”è¯¥æ˜¯ç§é’¥çš„ passwordã€‚
    - Disable execï¼šç¦æ­¢åœ¨ç›®æ ‡æœºä¸Šè¿è¡Œå‘½ä»¤ï¼Œå‹¾é€‰åå°†ä¼šå¿½ç•¥åœ¨ Job é…ç½®ä¸­â€œExec commandâ€é€‰é¡¹ä¸­è®¾ç½®çš„å‘½ä»¤ã€‚

    è¡¥å……ï¼šç”±äº Jenkins æ˜¯åœ¨ docker å®¹å™¨ä¸­è¿è¡Œçš„ï¼Œæ‰€ä»¥ä¸Šé¢çš„é…ç½®åº”è¯¥æ˜¯å®¹å™¨çš„ ssh é…ç½®ï¼Œè€Œä¸æ˜¯å®¿ä¸»æœºçš„ã€‚å¦‚ä¸Šå›¾ï¼Œæˆ‘æ˜¯é€šè¿‡ ssh ç§é’¥è¿›è¡Œçš„ç™»é™†ã€‚

    æ­¥éª¤ï¼š

    - `$ docker exec -it jenkins sh`ï¼Œè¿›å…¥å®¹å™¨ã€‚
    - `$ ssh-keygen -m PEM -t rsa -b 4096`ï¼Œç”Ÿæˆ ssh ç§é’¥åŠå…¬é’¥ï¼ˆé»˜è®¤åœ¨ `ï½/.ssh` å³ `/root/.ssh` ç›®å½•ä¸­ï¼‰ï¼Œå¯ä»¥ä¸€è·¯å›è½¦ï¼Œè‹¥è®¾å¯†ç çš„è¯ï¼Œéœ€åœ¨â€œPassphraseâ€ä¸­å¡«å†™ã€‚
    - `$ cat ~/.ssh/id_rsa`ï¼ŒæŸ¥çœ‹ç§é’¥ï¼ŒæŠŠç§é’¥ copy åˆ°ä¸Šå›¾çš„â€œkeyâ€è®¾ç½®ä¸­ã€‚
    - `$ cat ~/.ssh/id_rsa.pub`ï¼ŒæŸ¥çœ‹å…¬é’¥ï¼ŒæŠŠå…¬é’¥ copy åˆ°å®¿ä¸»æœºçš„ `~/.ssh/authorized_keys` ä¸­ã€‚

    è‡³æ­¤ï¼ŒJenkins çš„ ssh é…ç½®å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥è¦é…ç½®è¿œç¨‹æœºï¼ˆå’±ä»¬æ˜¯å•æœºï¼Œæ‰€ä»¥å®¿ä¸»æœºå°±å½“æˆè¿œç¨‹æœºæ¥é…ç½®ï¼‰çš„ SSH Servers äº†ï¼š
    ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a8676aa02a3f06?w=1550&h=801&f=jpeg&s=98093)

    è¯´æ˜ï¼š

    - Nameï¼šSSH èŠ‚ç‚¹é…ç½®çš„åç§°ï¼Œå¯éšæ„è®¾ç½®ï¼Œä»–å°†åœ¨ job é…ç½®çš„â€œSSH Serverâ€çš„ä¸‹æ‹‰åˆ—è¡¨ä¸­ï¼Œå¦‚å›¾ï¼š
      ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a867c4c88f0e33?w=1457&h=310&f=jpeg&s=55789)
    - Hostnameï¼šé€šè¿‡ SSH è¿æ¥åˆ°çš„æœºå™¨çš„ä¸»æœºåæˆ– IPã€‚
    - Usernameï¼šSSH æœåŠ¡ä½¿ç”¨çš„ usernameï¼Œä½¿ç”¨ key è¿›è¡Œè¿æ¥æ—¶ä¸º key æŒ‡å®šçš„ usernameã€‚
    - Remote Derictoryï¼šè¿ç¨‹æœºå™¨ä¸ŠçœŸå®å­˜åœ¨çš„æ–‡ä»¶å¤¹ï¼Œè€Œä¸”â€œUsernameâ€æŒ‡å®šçš„ç”¨æˆ·è¦æœ‰è¨ªé—®æ­¤æ–‡ä»¶å¤¹çš„æƒé™ã€‚æ’ä»¶å°†æŠŠæ–‡ä»¶ä¼ é€åˆ°æ­¤æ–‡ä»¶å¤¹ä¸‹ã€‚ä¸€èˆ¬æ˜¯å­˜æ”¾é¡¹ç›®çš„ç›®å½•ã€‚

- æµ‹è¯•ï¼Œç‚¹å‡»â€œTest Configurationâ€æŒ‰é’®ï¼Œå¦‚ successï¼Œè¿™é…ç½®æˆåŠŸï¼Œè¿›è¡Œä¸‹ä¸€æ­¥ï¼Œæ–°å»ºä»»åŠ¡ã€‚

ä¸‹é¢å¼€å§‹æ–°å»ºä»»åŠ¡ï¼š

- åœ¨é¦–é¡µç‚¹å‡»â€œæ–°å»ºä»»åŠ¡â€ï¼Œè¾“å…¥åç§°ï¼ˆå»ºè®®å’Œ github çš„é¡¹ç›®åç§°ä¿æŒä¸€è‡´ï¼‰ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªâ€œæ„å»ºä¸€ä¸ªè‡ªç”±é£æ ¼çš„è½¯ä»¶é¡¹ç›®â€ï¼Œç„¶åç‚¹å‡»ç¡®å®šï¼š
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a868dadef52c88?w=1323&h=889&f=jpeg&s=150657)

- è¿”å›é¦–é¡µï¼Œå¯ä»¥åˆ—è¡¨ä¸­çœ‹åˆ°åˆšåˆšæ–°å»ºçš„ä»»åŠ¡ï¼Œç‚¹å‡»åç§°ï¼Œè¿›å…¥ä»»åŠ¡è¯¦æƒ…ï¼š
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a8691ec9f9ffc8?w=1892&h=408&f=jpeg&s=92120)

- åœ¨ä»»åŠ¡è¯¦æƒ…é¡µï¼Œç‚¹å‡»é…ç½®ï¼Œè¿›è¡Œé¡¹ç›®é…ç½®ï¼š
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a8694201a42591?w=1380&h=666&f=jpeg&s=111899)
  é…ç½®ï¼š
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a8696c4a9a22c3?w=1464&h=936&f=jpeg&s=134812)
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a869b938e1ca63?w=1474&h=696&f=jpeg&s=124042)
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a86a6b4af97199?w=1486&h=938&f=jpeg&s=182802)
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a86addbd10b8e1?w=1438&h=397&f=jpeg&s=53446)
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a86b38b0729b30?w=1517&h=945&f=jpeg&s=200194)
  è¡¥å……ï¼šï¼ˆshell è„šæœ¬éƒ½åœ¨[é¡¹ç›®](https://github.com/daolou/newblog)çš„ deploy ç›®å½•ä¸‹ï¼‰

  - Exec commandï¼š

    ```shell
    #!/usr/bin/env bash
    echo '************************************** å‘é€è‡³æœåŠ¡å™¨æˆåŠŸ **********************************************'

    # é¡¹ç›®åï¼Œå–è‡ªç¯å¢ƒå˜é‡
    projectName="${JOB_NAME}"
    dockerImageName=${projectName}-${BUILD_TIMESTAMP}

    # step1 è§£å‹æºä»£ç 
    echo " ************************************* è§£å‹æºä»£ç ${dockerImageName}.tar.gz start *************************************"

    projectPath='/var/nodejs/' # éœ€è¦å•ç‹¬ç»™ç”¨æˆ·èµ‹ç›®å½•/var/nodejs/çš„æƒé™ sudo chown ubuntu /var/nodejs/
    sudo mkdir -p ${projectPath}${projectName} || true \
    && cd ${projectPath}${projectName} \
    && sudo rm -rf *  # åˆ é™¤é‡Œé¢çš„æ•°æ®

    sudo tar -zxf ../${dockerImageName}.tar.gz -C ./ \
    && sudo rm  ../${dockerImageName}.tar.gz   # åˆ é™¤å‘å¸ƒè¿‡æ¥çš„åŒ…

    echo " ************************************* è§£å‹æºä»£ç ${dockerImageName}.tar.gz finish *************************************"

    # step2 æ„å»ºdockeré•œåƒ
    echo " ************************************* æ„å»ºdockeré•œåƒ${dockerImageName} start *************************************"
    sudo docker build -t ${dockerImageName} --force-rm .
    echo ' ************************************* æ„å»ºdockeré•œåƒ finish *************************************'

    # step3 é‡å¯å®¹å™¨
    echo "************************************* ä½¿ç”¨é•œåƒ${dockerImageName}å¯åŠ¨å®¹å™¨${projectName}  start *************************************"
    # é”™è¯¯æ—¥å¿—ç»Ÿä¸€å­˜æ”¾åœ¨/var/nodejs/logs/${projectName}
    sudo mkdir -p /var/nodejs/logs/${projectName} || true \
    && sudo docker stop ${projectName} || true \
    && sudo docker rm ${projectName} || true \
    && sudo docker run -d --net=host --name ${projectName} -v /var/nodejs/logs/${projectName}:/var/nodejs/${projectName}/logs ${dockerImageName}

    echo "************************************* ä½¿ç”¨é•œåƒ${dockerImageName}å¯åŠ¨å®¹å™¨${projectName}  finish *************************************"

    echo '************************************************ æŸ¥çœ‹dockerå®¹å™¨æƒ…å†µ: ************************************************ '
    sudo docker ps -a
    echo '************************************************ æŸ¥çœ‹dockerå®¹å™¨æƒ…å†µ: ************************************************ '
    ```

  - å¦‚æœé¡¹ç›®éœ€è¦åœ¨å®¹å™¨é‡Œæ„å»ºï¼Œé€šå¸¸åˆæ¬¡æ„å»ºæ—¶é—´ç›¸å¯¹è¾ƒé•¿ï¼Œæ‰€ä»¥å¯ä»¥æŠŠé«˜çº§è®¾ç½®ä¸­çš„â€œExec timeoutâ€è®¾çš„ç¨å¾®å¤§ä¸€äº›ã€‚
  - æ„å»º-æ‰§è¡Œ shell-å‘½ä»¤ï¼š

    ```shell
    #!/usr/bin/env sh
    projectName="${JOB_NAME}"
    dockerImageName=${projectName}-${BUILD_TIMESTAMP}

    echo '*********************************** å‡†å¤‡æ‰“åŒ…ä»Githubä»“åº“æ‹‰å–çš„ä»£ç ...*********************************************'
    echo "**********${WORKSPACE}**********"
    tar --exclude=node_modules --exclude=.git --exclude='*.tar.gz'  -vzcf /tmp/${dockerImageName}.tar.gz -C  ${WORKSPACE} .  \
    && mv /tmp/${dockerImageName}.tar.gz  ${WORKSPACE} \
    && echo '*********************************** æ‰“åŒ…æˆåŠŸ *********************************************' \
    && echo '************************************** å‡†å¤‡å‘é€è‡³æœåŠ¡å™¨... **********************************************'
    ```

  - æ„å»ºåæ“ä½œï¼Œ[é’‰é’‰é€šçŸ¥é…ç½®æ•™ç¨‹](https://github.com/jenkinsci/dingding-notifications-plugin/blob/master/readme-cn.md)

- å®Œæˆé¡¹ç›®çš„ä»»åŠ¡é…ç½®ï¼Œç‚¹å‡»ä¿å­˜ã€‚

- è¿”å›ä»»åŠ¡è¯¦æƒ…ä¹Ÿï¼Œç‚¹å‡»â€œBuild with Parametersâ€ï¼Œé€‰æ‹©åˆ†æ”¯ï¼Œç‚¹å‡»â€œå¼€å§‹æ„å»ºâ€ï¼š
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a86bf6fd68dded?w=1262&h=547&f=jpeg&s=68479)
- åœ¨æ„å»ºå†å²åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»æœ€æ–°çš„ä¸€æ¡æ„å»ºè®°å½•ï¼Œå†ç‚¹â€œå‡»æ§åˆ¶å°è¾“å‡ºâ€ï¼Œå¯æŸ¥çœ‹æ„å»ºçš„ logï¼š
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a86c388073110a?w=1456&h=963&f=jpeg&s=231973)
  æœ€ç»ˆ log è¾“å‡ºï¼šFinished: SUCCESSï¼Œåˆ™æˆåŠŸã€‚v
  æ„å»ºåï¼Œé’‰é’‰ä¼šæ”¶åˆ°é€šçŸ¥ã€‚

å¦‚æœæœ‰é—®é¢˜ï¼Œéœ€è¦ç‰ˆæœ¬å›æ»šæ€ä¹ˆåŠå‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ªä»»åŠ¡ç”¨äºç‰ˆæœ¬å›æ»šï¼š

- å›åˆ°é¦–é¡µï¼Œç‚¹å‡»æ–°å»ºï¼Œèµ·ä¸ªåå­—å¦‚ï¼šnewblog-rollbackã€‚
- åœ¨åˆ—è¡¨ç‚¹å‡» newblog-rollbackï¼Œè¿›å…¥ä»»åŠ¡è¯¦æƒ…ï¼Œç‚¹å‡»é…ç½®ï¼Œè¿›å…¥é…ç½®é¡µï¼š
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a86f7dda3e2386?w=1457&h=579&f=jpeg&s=98099)
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a86f9ba3775fa7?w=1459&h=872&f=jpeg&s=140049)
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a86addbd10b8e1?w=1438&h=397&f=jpeg&s=53446)
  è¡¥å……ï¼šï¼ˆshell è„šæœ¬éƒ½åœ¨[é¡¹ç›®](https://github.com/daolou/newblog)çš„ deploy ç›®å½•ä¸‹ï¼‰

  - Exec commandï¼š

    ```shell
    #!/usr/bin/env sh

    trim()
    {
        trimmed=$1
        trimmed=${trimmed%% }
        trimmed=${trimmed## }
        echo "$trimmed"
    }

    # projectName=$(trim "${container_name}")
    projectName="newblog"

    dockerImageName=$(trim "${image_name}")

    echo "******************************************* å›é€€åˆ°é•œåƒ${image_name} ï¼Œå¹¶å¯åŠ¨å®¹å™¨${container_name} **************** *******************************"
    sudo mkdir -p /var/nodejs/logs/${projectName} || true \
    && sudo docker stop ${projectName} || true \
    && sudo docker rm ${projectName} || true \
    && sudo docker run -d --net=host --name ${projectName} -v /var/nodejs/logs/${projectName}:/var/nodejs/${projectName}/logs ${dockerImageName}
    echo "************************************* ä½¿ç”¨é•œåƒ${dockerImageName}å¯åŠ¨å®¹å™¨${projectName}  finish *************************************"
    ```

- æµ‹è¯•ç‰ˆæœ¬å›æ»šï¼Œé¦–å…ˆï¼Œä½ è¦çŸ¥é“è¦å›é€€åˆ°å“ªä¸ªç‰ˆæœ¬ï¼Œåœ¨ newblog ä»»åŠ¡åˆ—è¡¨ä¸­ copy ä½ è¦å›é€€çš„é•œåƒåï¼š
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a8706381b9bead?w=920&h=633&f=jpeg&s=108021)
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a8708af23a2e88?w=1170&h=513&f=jpeg&s=95187)
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a870c1c06a7c24?w=953&h=568&f=jpeg&s=95931)
  ![img](https://user-gold-cdn.xitu.io/2019/5/5/16a87223d40543ec?w=747&h=892&f=jpeg&s=121284)
  æœ€ç»ˆ log è¾“å‡ºï¼šFinished: SUCCESSï¼Œåˆ™æˆåŠŸã€‚

æœ€ç»ˆæˆæœï¼š<http://140.143.0.171:8080>

ã€å‚è€ƒã€‘ï¼š

1. <https://jenkins.io/>
2. [N-blog](https://github.com/nswbmw/N-blog)

===ğŸ§ğŸ§ _æ–‡ä¸­ä¸è¶³ï¼Œæ¬¢è¿æŒ‡æ­£_ ğŸ¤ªğŸ¤ª===

===å†…å®¹æœ‰ç‚¹å¤šï¼Œè‡ªæˆ‘æ„Ÿè§‰å†™çš„ä¸å¥½ï¼Œä½†ä¸çŸ¥æ€ä¹ˆä¼˜åŒ–ï¼Œæœ‰å¥½çš„å»ºè®®æ¬¢è¿æ===
